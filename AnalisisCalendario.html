<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario de Eventos | CapaSuite</title>
    <link rel="icon" type="image/png" href="Imagen/Icono_CapaSuite.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script src="js/storage.js"></script>
    <script src="js/firebase-auth.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #10b981;
            --accent: #f59e0b;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --bg-body: #f8fafc;
            --card-bg: #ffffff;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* HEADER & NAV (Shared) */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 30px;
            background: white;
            border-bottom: 1px solid var(--border);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .brand img.logo-main {
            height: 40px;
        }

        .hotel-logos {
            display: flex;
            gap: 15px;
        }

        .hotel-logos img {
            height: 40px;
        }

        .top-nav {
            background: #1e293b;
            padding: 0 30px;
            display: flex;
            align-items: center;
            height: 45px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            height: 100%;
        }

        .top-nav a {
            color: #94a3b8;
            text-decoration: none;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            height: 100%;
            border-bottom: 2px solid transparent;
        }

        .top-nav a:hover,
        .top-nav a.active {
            color: white;
            border-bottom-color: #818cf8;
        }

        /* MAIN CONTENT */
        main {
            padding: 20px;
            flex: 1;
        }

        .control-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border);
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
            min-width: 150px;
        }

        /* CALENDAR GRID */
        .calendar-year {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .month-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            position: relative;
        }

        .month-title {
            font-weight: 800;
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--text-main);
            text-transform: capitalize;
            display: flex;
            justify-content: space-between;
        }

        .days-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            margin-bottom: 5px;
        }

        .day-label {
            text-align: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .day-cell {
            aspect-ratio: 1;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            position: relative;
            cursor: pointer;
            transition: transform 0.1s;
            color: #1e293b;
        }

        .day-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--primary);
        }

        .day-cell.empty {
            background: transparent;
            cursor: default;
        }

        /* EVENT MARKERS via Borders */
        .event-marker {
            position: absolute;
            bottom: 2px;
            width: 4px;
            height: 4px;
            border-radius: 50%;
        }

        /* HEATMAP LEGEND */
        .legend {
            display: flex;
            gap: 5px;
            font-size: 0.75rem;
            align-items: center;
            margin-left: auto;
        }

        .legend-box {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        /* TOOLTIP */
        #tooltip {
            position: fixed;
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            pointer-events: none;
            z-index: 1000;
            display: none;
            width: 220px;
        }

        #tooltip h4 {
            margin: 0 0 5px 0;
            font-size: 0.9rem;
        }

        #tooltip .info-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            margin-bottom: 3px;
        }

        #tooltip .event-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            color: white;
            font-size: 0.7rem;
            margin-top: 5px;
            font-weight: bold;
        }

        /* EVENT MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 500px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        .modal-body label {
            display: block;
            margin-bottom: 5px;
            margin-top: 15px;
        }

        .modal-body input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            box-sizing: border-box;
        }

        .event-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.85rem;
        }

        .btn-delete {
            color: #ef4444;
            cursor: pointer;
            font-weight: bold;
            margin-left: 10px;
        }
    </style>
</head>

<body>

    <header class="header">
        <div class="brand">
            <img src="Imagen/logo, CapaSuite.png" alt="CapaSuite" class="logo-main">
            <div class="hotel-logos">
                <img src="Imagen/logo-guadiana.svg" alt="Guadiana" id="logo-guadiana">
                <img src="Imagen/logo-cumbria.svg" alt="Cumbria" id="logo-cumbria">
            </div>
        </div>
        <div>
            <span style="font-size: 0.8rem; font-weight: 600; color: var(--text-muted);">Usuario: </span>
            <span id="userEmail" style="font-size: 0.8rem;">Cargando...</span>
        </div>
    </header>

    <nav class="top-nav">
        <div class="nav-links">
            <a href="index.html">üè† Inicio</a>
            <a href="AnalisisProduccion.html">üìà Producci√≥n</a>
            <a href="AnalisisSegmentos.html">üë• Segmentos</a>
            <a href="AnalisisCompetencia.html">‚öñÔ∏è Competencia</a>
            <a href="AnalisisIA.html">‚ú® CapaAI</a>
            <a href="AnalisisCalendario.html" class="active">üìÖ Calendario</a>
            <a href="CalculadoraPresupuesto.html">üí∞ Presupuesto</a>
            <a href="CargarDatos.html">‚öôÔ∏è Config</a>
        </div>
    </nav>

    <main>
        <div class="hero" style="margin-bottom: 20px;">
            <h1 style="font-size: 1.8rem;">Calendario de Eventos & Revenue</h1>
            <p style="color: var(--text-muted);">Visualizaci√≥n t√©rmica de demanda y eventos locales.</p>
        </div>

        <div class="control-bar">
            <div class="control-group">
                <label>Hotel</label>
                <select id="hotelSelector" onchange="renderCalendar()">
                    <option value="Guadiana">Guadiana</option>
                    <option value="Cumbria">Cumbria</option>
                </select>
            </div>
            <div class="control-group">
                <label>A√±o</label>
                <select id="yearSelector" onchange="renderCalendar()">
                    <option value="2025">2025</option>
                    <option value="2026" selected>2026</option>
                    <option value="2027">2027</option>
                </select>
            </div>
            <div class="control-group">
                <label>M√©trica Mapa T√©rmico</label>
                <select id="metricSelector" onchange="renderCalendar()">
                    <option value="price">Tarifa (ADR)</option>
                    <option value="occupancy">Ocupaci√≥n (%)</option>
                </select>
            </div>

            <button onclick="openEventModal()"
                style="margin-left:auto; margin-right:20px; background:var(--primary); color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:600; font-size:0.85rem;">
                + Eventos
            </button>

            <div class="legend">
                <span>Bajo</span>
                <div class="legend-box" style="background:#e0e7ff"></div>
                <div class="legend-box" style="background:#a5b4fc"></div>
                <div class="legend-box" style="background:#6366f1"></div>
                <div class="legend-box" style="background:#4338ca"></div>
                <div class="legend-box" style="background:#312e81"></div>
                <span>Alto</span>
            </div>
        </div>

        <div id="calendarGrid" class="calendar-year"></div>
    </main>

    <!-- Tooltip -->
    <div id="tooltip"></div>

    <!-- EVENT MODAL -->
    <div id="eventModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0;">Gestionar Eventos</h3>
                <button onclick="closeEventModal()" style="border:none; bg:transparent; cursor:pointer;">‚úï</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:15px; text-align:center;">
                    <input type="file" id="excelInput" accept=".xlsx, .xls" style="display:none;"
                        onchange="importEventsFromExcel(this)">
                    <button onclick="document.getElementById('excelInput').click()"
                        style="background:#10b981; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:600; display:flex; align-items:center; justify-content:center; width:100%;">
                        üìÇ Importar desde Excel
                    </button>
                    <p style="font-size:0.75rem; color:#64748b; margin-top:5px;">Formato: Fecha Inicio | Fecha Fin |
                        Descripci√≥n</p>
                </div>

                <div style="background:#f8fafc; padding:15px; border-radius:8px; margin-bottom:20px;">
                    <h4 style="margin:0 0 10px 0;">Nuevo Evento Manual</h4>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div>
                            <label>Fecha Inicio</label>
                            <input type="date" id="newEventStart">
                        </div>
                        <div>
                            <label>Fecha Fin</label>
                            <input type="date" id="newEventEnd">
                        </div>
                    </div>
                    <label>Descripci√≥n</label>
                    <input type="text" id="newEventDesc" placeholder="Ej: Feria Local">

                    <label>Color (Hex)</label>
                    <select id="newEventColor"
                        style="width:100%; padding:8px; border-radius:6px; border:1px solid #e2e8f0;">
                        <option value="255">Azul</option>
                        <option value="65280">Verde</option>
                        <option value="16711680">Rojo</option>
                        <option value="16776960">Amarillo</option>
                    </select>

                    <button onclick="saveEvent()"
                        style="width:100%; margin-top:15px; background:var(--primary); color:white; border:none; padding:10px; border-radius:6px; cursor:pointer;">Guardar
                        Evento</button>
                </div>

                <h4 style="margin-bottom:10px;">Eventos Guardados</h4>
                <div id="existingEventsList" style="max-height:200px; overflow-y:auto;">
                    <!-- List items here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        // --- DATA ---
        // Load events from storage or fall back to defaults
        let rawEvents = [];
        const savedEvents = CapaStorage.getItem('custom_events');

        if (savedEvents) {
            try {
                rawEvents = JSON.parse(savedEvents);
            } catch (e) { console.error("Error parsing events", e); }
        } else {
            // Defaults if nothing saved
            rawEvents = [
                { start: "2026-02-14", end: "2026-02-14", desc: "NR / ENAMORADOS", color: 255 },
                { start: "2026-01-16", end: "2026-01-17", desc: "Salsea 2026", color: 255 },
                { start: "2026-02-21", end: "2026-02-21", desc: "Fin de Carnaval", color: 65280 },
                { start: "2026-03-20", end: "2026-03-21", desc: "Campeonatos de Espa√±a de Duatl√≥n", color: 255 },
                { start: "2026-06-19", end: "2026-06-19", desc: "(probable) Oposici√≥n", color: 255 },
                { start: "2026-05-01", end: "2026-05-02", desc: "Puente Mayo trabajo", color: 16711680 },
                { start: "2026-10-17", end: "2026-10-17", desc: "(probable) El Quijote Marat√≥n", color: 16711680 },
                { start: "2026-10-10", end: "2026-10-10", desc: "(probable) El Quijote Marat√≥n", color: 16711680 },
                { start: "2026-03-13", end: "2026-03-14", desc: "NR ¬øCampeonatos de Espa√±a de Duatl√≥n", color: 255 },
                { start: "2026-03-07", end: "2026-03-07", desc: "NR / Concierto Fito & Fitipaldis", color: 255 },
                { start: "2025-12-31", end: "2025-12-31", desc: "NR", color: 255 },
                { start: "2025-12-06", end: "2025-12-07", desc: "NR/ Pte Constituci√≥n", color: 255 },
                { start: "2026-01-23", end: "2026-01-24", desc: "Campeonato tiro con arco", color: 16711680 },
                { start: "2026-08-13", end: "2026-08-15", desc: "Feria y Fiestas Virgen del Prado", color: 16711680 },
                { start: "2026-04-02", end: "2026-04-04", desc: "Semana Santa 2026", color: 255 },
                { start: "2026-09-25", end: "2026-09-26", desc: "Fercatur", color: 65280 },
                { start: "2026-04-13", end: "2026-04-16", desc: "NR/ XVI Congreso Nacional de Regantes", color: 255 },
                { start: "2026-05-29", end: "2026-05-30", desc: "Crossfit Games 2026", color: 65280 },
                { start: "2027-05-10", end: "2027-05-12", desc: "Fenavin 2027", color: 255 },
                { start: "2026-12-05", end: "2026-12-07", desc: "Puente de la Constituci√≥n", color: 255 },
                { start: "2026-05-04", end: "2026-05-06", desc: "Congreso", color: 16711680 },
                { start: "2026-06-05", end: "2026-06-06", desc: "Baila Conmigo 2026", color: 255 }
            ];
        }

        // --- EVENT MANAGEMENT ---
        function openEventModal() {
            document.getElementById('eventModal').style.display = 'flex';
            renderEventList();
        }

        function closeEventModal() {
            document.getElementById('eventModal').style.display = 'none';
            renderCalendar(); // Re-render to show changes
        }

        function saveEvent() {
            const start = document.getElementById('newEventStart').value;
            const end = document.getElementById('newEventEnd').value;
            const desc = document.getElementById('newEventDesc').value;
            const color = parseInt(document.getElementById('newEventColor').value);

            if (!start || !end || !desc) {
                alert("Por favor completa todos los campos");
                return;
            }

            rawEvents.push({ start, end, desc, color });
            CapaStorage.setItem('custom_events', JSON.stringify(rawEvents));

            // Clear form
            document.getElementById('newEventDesc').value = '';

            renderEventList();
        }

        function deleteEvent(index) {
            if (confirm("¬øBorrar evento?")) {
                rawEvents.splice(index, 1);
                CapaStorage.setItem('custom_events', JSON.stringify(rawEvents));
                renderEventList();
            }
        }

        function renderEventList() {
            const container = document.getElementById('existingEventsList');
            container.innerHTML = '';

            // Sort by date reverse
            const sorted = [...rawEvents].sort((a, b) => new Date(b.start) - new Date(a.start));

            sorted.forEach((ev, idx) => {
                // Find original index for deletion
                const originalIndex = rawEvents.indexOf(ev);

                const div = document.createElement('div');
                div.className = 'event-list-item';
                div.innerHTML = `
                    <div>
                        <span style="font-weight:bold; color:${intToHex(ev.color)}">‚óè</span> 
                        ${ev.start} - <strong>${ev.desc}</strong>
                    </div>
                    <span class="btn-delete" onclick="deleteEvent(${originalIndex})">üóëÔ∏è</span>
                `;
                container.appendChild(div);
            });
        }

        // --- EXCEL IMPORT ---
        function importEventsFromExcel(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Assume first sheet
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // Convert to JSON (header:1 generates array of arrays, safest to detect structure)
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, dateNF: 'yyyy-mm-dd' });

                    if (!json || json.length < 2) {
                        alert("El archivo parece vac√≠o o sin datos v√°lidos.");
                        return;
                    }

                    // Simple Heuristic: Assume columns A, B, C are Start, End, Desc
                    // Or look for headers in row 0
                    let startCol = 0;
                    let endCol = 1;
                    let descCol = 2;

                    // Skip header row if it looks like text
                    let startIndex = 0;
                    // Check if first cell is dates
                    if (isNaN(Date.parse(json[0][0])) && String(json[0][0]).length > 4) {
                        startIndex = 1; // Row 0 is likely header
                    }

                    let addedCount = 0;

                    for (let i = startIndex; i < json.length; i++) {
                        const row = json[i];
                        if (!row || row.length === 0) continue;

                        let sDate = row[startCol];
                        let eDate = row[endCol];
                        let desc = row[descCol];

                        // Handle strict 1 column case (Start = End) or missing End
                        if (!eDate && sDate) eDate = sDate;
                        // Handle case where Desc is in Col 2 (B)
                        if (!desc && row.length === 2 && isNaN(Date.parse(row[1]))) desc = row[1];
                        // Handle case where Desc is in Col 3 (C)
                        if (!desc && row.length > 2) desc = row[2];

                        // Basic Validation
                        if (sDate && desc) {
                            // Ensure ISO format YYYY-MM-DD
                            // Logic: If it has slashes 2026/01/01 convert to dashes
                            if (typeof sDate === 'string' && sDate.includes('/')) sDate = sDate.replace(/\//g, '-');
                            if (typeof eDate === 'string' && eDate.includes('/')) eDate = eDate.replace(/\//g, '-');

                            // Reorder DD-MM-YYYY to YYYY-MM-DD if needed (simple check)
                            if (typeof sDate === 'string') {
                                const dateParts = sDate.split('-');
                                if (dateParts[0].length === 2 && dateParts[2] && dateParts[2].length === 4) {
                                    sDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
                                }
                            }
                            if (typeof eDate === 'string' && eDate.includes('-')) {
                                const eParts = eDate.split('-');
                                if (eParts[0].length === 2 && eParts[2] && eParts[2].length === 4) {
                                    eDate = `${eParts[2]}-${eParts[1]}-${eParts[0]}`;
                                }
                            }

                            // Add
                            rawEvents.push({
                                start: sDate,
                                end: eDate,
                                desc: desc,
                                color: 255 // Default blue
                            });
                            addedCount++;
                        }
                    }

                    if (addedCount > 0) {
                        CapaStorage.setItem('custom_events', JSON.stringify(rawEvents));
                        renderEventList();
                        renderCalendar(); // Visual update
                        alert(`¬°√âxito! Se han importado ${addedCount} eventos.`);
                    } else {
                        alert("No se pudieron encontrar eventos v√°lidos. Revisa el formato (Columnas: Inicio, Fin, Descripci√≥n).");
                    }

                } catch (err) {
                    console.error("Error reading Excel", err);
                    alert("Error al leer el archivo Excel: " + err.message);
                }

                // Reset input
                input.value = '';
            };

            reader.readAsArrayBuffer(file);
        }

        let revenueData = {};

        window.onload = async () => {
            // Load Competitor Data (Prices)
            try {
                const rawComp = CapaStorage.getItem('revenue_data_v2');
                if (rawComp) {
                    const parsed = JSON.parse(rawComp);
                    parsed.data.forEach(d => {
                        revenueData[d.dateISO] = d;
                    });
                    console.log(`Loaded ${Object.keys(revenueData).length} days of market data`);
                }
            } catch (e) {
                console.error("Error loading revenue data", e);
            }

            // Load Production Data (Occupancy/OTB) - ENRICHMENT
            try {
                const rawProd = CapaStorage.getItem('hotel_manager_db_v2');
                if (rawProd) {
                    const db = JSON.parse(rawProd);

                    // Iterate all loaded revenue dates to inject OTB
                    Object.keys(revenueData).forEach(iso => {
                        const d = revenueData[iso];
                        const parts = iso.split('-');
                        const year = parts[0];

                        // We need to check BOTH hotels because the calendar allows switching
                        ['Guadiana', 'Cumbria'].forEach(hName => {
                            // Try to find this date in the DB
                            // The DB structure is db[HotelName][Year].daily_otb[iso]
                            const hKey = Object.keys(db).find(k => k.toLowerCase().includes(hName.toLowerCase()));

                            if (hKey && db[hKey][year]) {
                                let otb = 0;
                                let occ = 0;

                                // Check OTB
                                if (db[hKey][year].daily_otb && db[hKey][year].daily_otb[iso]) {
                                    const val = db[hKey][year].daily_otb[iso];
                                    otb = (typeof val === 'object') ? (val.rooms || 0) : val;
                                }

                                // Check Daily (Real Past)
                                if (db[hKey][year].daily && db[hKey][year].daily[iso]) {
                                    occ = db[hKey][year].daily[iso];
                                }

                                // Save to our data object specifically for this hotel
                                if (!d.occupancyData) d.occupancyData = {};
                                d.occupancyData[hName] = { otb: otb, occ: occ };
                            }
                        });
                    });
                    console.log("Occupancy data synced.");
                }
            } catch (e) {
                console.error("Error syncing production data", e);
            }

            renderCalendar();
        };

        function intToHex(intColor) {
            // Standard RGB int to Hex
            // 255 -> Blue (0x0000FF)
            // 65280 -> Green (0x00FF00)
            // 16711680 -> Red (0xFF0000)
            const hex = intColor.toString(16).padStart(6, '0');
            return "#" + hex;
        }

        function renderCalendar() {
            const container = document.getElementById('calendarGrid');
            container.innerHTML = '';

            const year = parseInt(document.getElementById('yearSelector').value);
            const hotel = document.getElementById('hotelSelector').value;
            const metric = document.getElementById('metricSelector').value; // 'price' or 'occupancy'

            const months = [
                "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
            ];

            // 1. Calculate color scale domains
            // Find Min/Max for the selected year to normalize heatmap
            let minVal = 9999, maxVal = 0;

            Object.values(revenueData).forEach(d => {
                const dYear = new Date(d.dateISO).getFullYear();
                if (dYear === year) {
                    let val = 0;
                    if (metric === 'price') {
                        val = (d.hotels[hotel] && d.hotels[hotel].price) ? d.hotels[hotel].price : 0;
                    } else {
                        // Occupancy
                        const cap = (hotel === 'Cumbria' ? 59 : 108);
                        const rooms = d.otbRooms || d.occupancy || 0;
                        val = (rooms / cap) * 100;
                    }
                    if (val > 0) {
                        minVal = Math.min(minVal, val);
                        maxVal = Math.max(maxVal, val);
                    }
                }
            });
            if (minVal > maxVal) { minVal = 0; maxVal = 100; } // Fallback

            // Render 12 Months
            for (let m = 0; m < 12; m++) {
                const monthCard = document.createElement('div');
                monthCard.className = 'month-card';

                const title = document.createElement('div');
                title.className = 'month-title';
                title.innerText = months[m];
                monthCard.appendChild(title);

                const daysHeader = document.createElement('div');
                daysHeader.className = 'days-header';
                ['L', 'M', 'X', 'J', 'V', 'S', 'D'].forEach(d => {
                    const l = document.createElement('div');
                    l.className = 'day-label';
                    l.innerText = d;
                    daysHeader.appendChild(l);
                });
                monthCard.appendChild(daysHeader);

                const grid = document.createElement('div');
                grid.className = 'days-grid';

                // Days Logic
                const firstDay = new Date(year, m, 1);
                // Adjust for Monday start (JS 0=Sun)
                let startDay = firstDay.getDay();
                if (startDay === 0) startDay = 7; // Sunday=7

                const daysInMonth = new Date(year, m + 1, 0).getDate();

                // Empty cells before start
                for (let i = 1; i < startDay; i++) {
                    const empty = document.createElement('div');
                    empty.className = 'day-cell empty';
                    grid.appendChild(empty);
                }

                // Days
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                for (let d = 1; d <= daysInMonth; d++) {
                    const dateObj = new Date(year, m, d);
                    const iso = `${year}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

                    const cell = document.createElement('div');
                    cell.className = 'day-cell';
                    cell.innerText = d;
                    cell.dataset.iso = iso;

                    // --- DATA RETRIEVAL ---
                    const dData = revenueData[iso];
                    let val = 0;
                    let compAvg = 0;
                    let roomsSold = 0;

                    if (dData) {
                        compAvg = dData.compAvg || 0;

                        // Get Enriched Data for specific hotel
                        const hData = (dData.occupancyData && dData.occupancyData[hotel]) ? dData.occupancyData[hotel] : { otb: 0, occ: 0 };

                        // ALWAYS calculate roomsSold for Tooltip usage
                        const cap = (hotel === 'Cumbria' ? 59 : 108);
                        roomsSold = (hData.occ > 0) ? hData.occ : hData.otb;
                        // Fallback to sheet data if DB enrichment failed (e.g. initial upload only)
                        if (roomsSold === 0 && dData.otbRooms) roomsSold = dData.otbRooms;

                        if (metric === 'price') {
                            val = (dData.hotels[hotel] && dData.hotels[hotel].price) ? dData.hotels[hotel].price : 0;
                            // Fallback if price is 0 but we have valid data in original source
                            if (val === 0 && dData.hotels[hotel]) val = dData.hotels[hotel];
                        } else {
                            // Occupancy Metric for Heatmap
                            val = (roomsSold / cap) * 100;
                        }
                    }

                    // --- VISUAL STYLES ---
                    const isPast = dateObj < today;

                    // Pre-calculate Occupancy for closed status check
                    const capCheck = (hotel === 'Cumbria' ? 59 : 108);
                    const occPctCheck = (roomsSold / capCheck) * 100;
                    // Check if strictly closed (>=98%) or Price is invalid while in Price Mode (NaN)
                    // Note: val is 0 if empty, so we check isNaN specifically for parsing errors
                    const isClosed = occPctCheck >= 98 || (metric === 'price' && isNaN(val) && dData && dData.hotels && dData.hotels[hotel]);

                    // Heatmap Intensity
                    if (isClosed) {
                        // CLOSED / FULL STATUS - RED BACKGROUND
                        cell.style.backgroundColor = '#fecaca'; // Red-200
                        cell.style.color = '#b91c1c'; // Red-700
                        cell.style.border = '2px solid #f87171'; // Red-400
                        cell.style.fontWeight = '800';
                    }
                    else if (val > 0) {
                        const range = maxVal - minVal;
                        // Avoid division by zero
                        const pct = range > 0 ? (val - minVal) / range : 0.5;

                        // HSL Blue scale - Adjusted to ensure visibility
                        // Start at 88% (Light Blue) down to 30% (Dark Blue)
                        const l = 88 - (pct * 58);

                        cell.style.backgroundColor = `hsl(230, 90%, ${l}%)`;

                        // Text contrast
                        if (l < 60) {
                            cell.style.color = 'white';
                        } else {
                            cell.style.color = '#1e293b';
                        }

                        // Add a border to make it distinct
                        cell.style.borderColor = `hsl(230, 90%, ${l - 10}%)`;
                    } else {
                        // Empty/Zero values
                        cell.style.backgroundColor = '#f8fafc'; // Very light gray for empty
                        cell.style.color = '#cbd5e1';
                    }

                    // Past Date Styling (Grayed out)
                    if (isPast) {
                        cell.style.opacity = '0.6';
                        cell.style.filter = 'grayscale(100%)';
                        cell.style.textDecoration = 'line-through';
                        // Keep background but muted
                    }

                    // --- EVENTS ---
                    // Use String comparison to avoid Timezone headaches
                    // iso format 'YYYY-MM-DD' compares correctly as string
                    const ev = rawEvents.find(e => {
                        return iso >= e.start && iso <= e.end;
                    });

                    if (ev) {
                        cell.style.border = `2px solid ${intToHex(ev.color)}`;
                        cell.dataset.eventDesc = ev.desc;
                        cell.dataset.eventColor = intToHex(ev.color);
                    }

                    // --- INTERACTION ---
                    // Store strict data in DOM to avoid closure scope issues
                    cell.dataset.val = val;
                    cell.dataset.compAvg = compAvg;
                    cell.dataset.roomsSold = roomsSold;

                    // Pass only event to handler (data is on target)
                    cell.onmouseenter = showTooltip;
                    cell.onmouseleave = hideTooltip;

                    grid.appendChild(cell);
                }

                monthCard.appendChild(grid);
                container.appendChild(monthCard);
            }
        }

        const tooltip = document.getElementById('tooltip');

        function showTooltip(e) {
            const cell = e.target;
            const iso = cell.dataset.iso;
            const hotel = document.getElementById('hotelSelector').value;

            // Retrieve data from dataset (all strings, need parsing)
            const val = parseFloat(cell.dataset.val || 0);
            const compAvg = parseFloat(cell.dataset.compAvg || 0);
            const roomsSold = parseFloat(cell.dataset.roomsSold || 0);
            const eventDesc = cell.dataset.eventDesc;
            const eventColor = cell.dataset.eventColor;

            // Global data lookup for competitor details
            const dData = revenueData[iso];

            // --- OUR HOTEL SECTION ---
            let myHtml = '';
            if (val > 0 || roomsSold > 0) {
                // Occ Calculation logic pulled up
                const cap = (hotel === 'Cumbria' ? 59 : 108);
                const occValue = (roomsSold / cap) * 100;
                const metric = document.getElementById('metricSelector').value;

                // Logic for "CERRADO" / Price Display
                let priceDisp = '';

                // 1. If effectively full (>=98%) or Price is invalid (NaN) implies closed/sold out
                if (occValue >= 98 || isNaN(val)) {
                    priceDisp = `<span style="background:#fee2e2; color:#ef4444; padding:2px 6px; border-radius:4px; font-size:0.7rem; font-weight:800; letter-spacing:0.5px;">CERRADO</span>`;
                } else {
                    // 2. Normal Price Display
                    if (metric === 'price') {
                        priceDisp = (val > 0) ? `<strong>${val.toFixed(0)}‚Ç¨</strong>` : '-';
                    } else {
                        // Fetch price from raw data if we are in occupancy mode
                        const rawP = (dData && dData.hotels[hotel] && dData.hotels[hotel].price) ? dData.hotels[hotel].price : (parseFloat((dData && dData.hotels[hotel]) || 0));
                        priceDisp = (rawP > 0) ? `${rawP}‚Ç¨` : '-';
                    }
                }

                // Occ Display
                const occDisp = (metric === 'occupancy') ?
                    `<strong>${occValue.toFixed(0)}%</strong>` :
                    (roomsSold > 0) ? `${occValue.toFixed(0)}%` : '-';

                myHtml = `
                    <div class="info-row" style="border-bottom:1px solid #eee; padding-bottom:4px; margin-bottom:4px;">
                        <span style="color:var(--primary); font-weight:700;">üè® ${hotel}</span>
                        <div style="text-align:right">
                            <div style="font-size:0.85rem">${priceDisp}</div>
                            <div style="font-size:0.65rem; color:#64748b;">Ocup: ${occDisp}</div>
                        </div>
                    </div>
                `;
            } else {
                myHtml = `<div class="info-row" style="color:var(--text-muted)">Sin datos propios</div>`;
            }

            // --- COMPETITORS LIST ---
            let compHtml = '';
            if (dData && dData.hotels) {
                const comps = [];
                Object.keys(dData.hotels).forEach(hName => {
                    // Exclude current selected hotel
                    if (hName === hotel) return;

                    const hVal = dData.hotels[hName];
                    let p = 0;
                    let sold = false;

                    if (typeof hVal === 'object') {
                        p = hVal.price;
                        sold = hVal.sold;
                    } else {
                        p = hVal;
                    }

                    if (p > 0 || sold) {
                        comps.push({ name: hName, price: p, sold: sold });
                    }
                });

                // Sort by price
                comps.sort((a, b) => a.price - b.price);

                if (comps.length > 0) {
                    compHtml = `<div style="margin-top:6px; padding-top:4px; border-top:1px solid #f1f5f9;">
                        <div style="font-size:0.65rem; color:#94a3b8; font-weight:700; margin-bottom:2px;">COMPETENCIA</div>`;

                    comps.forEach(c => {
                        let pText = c.sold ? '<span style="color:#ef4444; font-weight:bold;">SOLD</span>' : `${c.price}‚Ç¨`;
                        const isOwnGroup = (c.name === 'Guadiana' || c.name === 'Cumbria');
                        // Highlight sister hotel
                        const rowStyle = isOwnGroup ? 'font-weight:700; color:#4f46e5;' : 'color:#334155;';

                        compHtml += `
                            <div style="display:flex; justify-content:space-between; font-size:0.75rem; ${rowStyle}">
                                <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:140px;">${c.name}</span>
                                <span>${pText}</span>
                            </div>
                        `;
                    });
                    compHtml += `</div>`;
                }
            }

            let eventHtml = '';
            if (eventDesc) {
                const colorHex = eventColor || '#4f46e5';
                eventHtml = `<div class="event-badge" style="background:${colorHex}; margin-top:8px;">${eventDesc}</div>`;
            }

            tooltip.innerHTML = `
                <h4 style="margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">
                    <span>üìÖ ${iso}</span>
                    <span style="font-size:0.7rem; font-weight:normal; color:#64748b;">${compAvg > 0 ? 'Mkt: ' + compAvg.toFixed(0) + '‚Ç¨' : ''}</span>
                </h4>
                ${myHtml}
                ${compHtml}
                ${eventHtml}
            `;

            // --- POSITIONING ---
            tooltip.style.display = 'block'; // Show first to measure
            const tRect = tooltip.getBoundingClientRect();
            const elRect = cell.getBoundingClientRect();
            const margin = 12;

            // Default: Place to the RIGHT of the cell
            let left = elRect.right + margin;
            // Center vertically relative to cell
            let top = elRect.top + (elRect.height / 2) - (tRect.height / 2);

            // Check RIGHT Edge
            if (left + tRect.width > window.innerWidth - margin) {
                // Flip to LEFT
                left = elRect.left - tRect.width - margin;
            }

            // Check TOP Edge
            if (top < margin) top = margin;

            // Check BOTTOM Edge
            if (top + tRect.height > window.innerHeight - margin) {
                top = window.innerHeight - tRect.height - margin;
            }

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }

        function hideTooltip() {
            tooltip.style.display = 'none';
        }

    </script>
</body>

</html>