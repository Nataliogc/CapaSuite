<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis de Producci√≥n | CapaSuite</title>
    <link rel="icon" type="image/png" href="Imagen/Icono_CapaSuite.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="Imagen/Icono_CapaSuite.png">
    <script src="js/chart.js"></script>
    <script src="js/storage.js"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #3730a3;
            --bg-body: #f8fafc;
            --bg-surface: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --radius: 12px;
            --success: #10b981;
            --warning: #f59e0b;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 15px;
            font-size: 13px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: var(--bg-surface);
            padding: 20px 30px;
            border-radius: var(--radius);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .title h1 {
            font-size: 1.5rem;
            margin: 0;
            color: var(--primary-dark);
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            position: relative;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 24px;
        }

        .kpi-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .kpi-value {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .kpi-trend {
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .trend-up {
            color: var(--success);
        }

        .trend-down {
            color: #ef4444;
        }

        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .chart-card {
            display: flex;
            flex-direction: column;
            height: 400px;
        }

        .chart-container {
            flex: 1;
            position: relative;
            min-height: 0;
        }

        .table-container {
            overflow: auto;
            max-height: 500px;
            border-radius: var(--radius);
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap;
        }

        th,
        td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            text-align: right;
            font-size: 0.85rem;
        }

        th {
            background: #f1f5f9;
            color: var(--text-muted);
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.7rem;
            text-transform: uppercase;
        }

        th:first-child,
        td:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: inherit;
            z-index: 11;
            font-weight: 600;
        }

        .row-group {
            background: #f8fafc;
            font-weight: 700;
            color: var(--primary);
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .upload-area {
            background: var(--bg-surface);
            border: 2px dashed #cbd5e1;
            border-radius: 16px;
            padding: 60px;
            text-align: center;
            cursor: pointer;
        }

        .loader {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            position: relative;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        .modal-header {
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        /* TOP NAVIGATION */
        .top-nav {
            background: #1e293b;
            padding: 6px 20px;
            display: flex;
            justify-content: center;
            gap: 25px;
            position: sticky;
            top: 0;
            z-index: 99999;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .top-nav a {
            color: #94a3b8;
            text-decoration: none;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            padding: 4px 0;
        }

        .top-nav a:hover {
            color: #ffffff;
            transform: translateY(-1px);
        }

        .top-nav a.active {
            color: #818cf8;
            border-bottom: 2px solid #818cf8;
        }
    </style>
</head>

<body style="padding: 0;">
    <nav class="top-nav">
        <a href="index.html">üè† Inicio</a>
        <a href="AnalisisProduccion.html" class="active">üìà Producci√≥n</a>
        <a href="AnalisisSegmentos.html">üë• Segmentos</a>
        <a href="AnalisisCompetencia.html">‚öñÔ∏è Competencia</a>
        <a href="CalculadoraPresupuesto.html">üí∞ Presupuesto</a>
        <a href="CargarDatos.html">‚öôÔ∏è Config</a>
    </nav>
    <div class="container" style="padding: 15px;">
        <header class="header">
            <div style="display: flex; align-items: center; gap: 20px;">
                <a href="index.html"><img src="Imagen/logo, CapaSuite.png" alt="CapaSuite" style="height: 50px;"></a>
                <img id="hotelLogo" src="Imagen/logo-guadiana.svg" alt="Logo Hotel" style="height: 45px;">
                <div class="title">
                    <h1 id="mainTitle">Revenue Assistant</h1>
                    <div style="display: flex; align-items: center; gap: 12px; margin-top: 2px;">
                        <p id="mainSubtitle" style="margin:0;">An√°lisis Pace y Producci√≥n Detallada</p>
                        <span id="updateBadge"
                            style="display:none; font-size: 0.75rem; background: #fee2e2; color: #b91c1c; padding: 3px 12px; border-radius: 20px; font-weight: 600; border: 1px solid #fecaca; white-space: nowrap;">üìÖ
                            Actualizado: --</span>
                    </div>
                </div>
            </div>
            <div style="display:flex; gap:12px; align-items:center;">
                <select id="yearSelector" onchange="updateView()"
                    style="padding:10px; border-radius:8px; border:1px solid #e2e8f0;"></select>
                <select id="monthSelector" onchange="updateView()"
                    style="padding:10px; border-radius:8px; border:1px solid #e2e8f0;"></select>
                <select id="hotelSelector" onchange="switchHotel(this.value)"
                    style="padding:10px; border-radius:8px; border:1px solid #e2e8f0; font-weight:600;">
                    <option value="Guadiana">Hotel Guadiana</option>
                    <option value="Cumbria">Hotel Cumbria</option>
                </select>
            </div>
        </header>

        <div id="no-data-section" class="upload-area" style="display:none;">
            <div style="font-size: 3rem; margin-bottom: 20px;">üõ°Ô∏è</div>
            <h2>No se han encontrado datos</h2>
            <p>Por favor, utiliza el m√≥dulo de <b>Carga de Datos</b> para importar tus informes.</p>
            <a href="CargarDatos.html" class="btn"
                style="display:inline-block; text-decoration:none; margin-top:20px;">Ir a Carga de Datos</a>
        </div>

        <div id="loader" class="loader"></div>

        <div id="dashboard" style="display:none; flex-direction:column; gap:24px;">
            <div class="kpi-grid">
                <div class="card" style="border-left: 4px solid var(--primary);">
                    <div class="kpi-label">Producci√≥n Total</div>
                    <div class="kpi-value" id="kpi-total">0 ‚Ç¨</div>
                    <div class="kpi-trend" id="trend-total">--</div>
                </div>
                <div class="card">
                    <div class="kpi-label">Prod. Habitaci√≥n</div>
                    <div class="kpi-value" id="kpi-prod-hab">0 ‚Ç¨</div>
                    <div class="kpi-trend" id="trend-prod-hab">--</div>
                </div>
                <div class="card">
                    <div class="kpi-label">Estancias (RN)</div>
                    <div class="kpi-value" id="kpi-rn">0</div>
                    <div class="kpi-trend" id="trend-rn">--</div>
                </div>
                <div class="card">
                    <div class="kpi-label">Total Pax</div>
                    <div class="kpi-value" id="kpi-pax">0</div>
                    <div class="kpi-trend" id="trend-pax">--</div>
                </div>
                <div class="card" style="background: #f0fdf4;">
                    <div class="kpi-label" style="color: #166534;">ADR (Precio Medio)</div>
                    <div class="kpi-value" id="kpi-adr" style="color: #166534;">0 ‚Ç¨</div>
                    <div class="kpi-trend" id="trend-adr">--</div>
                </div>
                <div class="card" style="background: #eff6ff;">
                    <div class="kpi-label" style="color: #1e40af;">RevPAC (Gasto Total/Pax)</div>
                    <div class="kpi-value" id="kpi-revpac" style="color: #1e40af;">0 ‚Ç¨</div>
                    <div class="kpi-trend" id="trend-revpac">--</div>
                </div>
                <div class="card">
                    <div class="kpi-label">Ocupaci√≥n</div>
                    <div class="kpi-value" id="kpi-occ">0 %</div>
                    <div class="kpi-trend" id="trend-occ">--</div>
                </div>
                <div class="card">
                    <div class="kpi-label">Gasto Comp. / Pax</div>
                    <div class="kpi-value" id="kpi-comppax">0 ‚Ç¨</div>
                    <div class="kpi-trend" id="trend-comppax">--</div>
                </div>
            </div>

            <div class="charts-row" style="grid-template-columns: 1.5fr 1fr 1fr;">
                <div class="card chart-card">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div class="kpi-label" style="margin-bottom: 0;">Evoluci√≥n Mensual Detallada</div>
                        <select id="chartMetricSelector" onchange="render()"
                            style="font-size: 0.75rem; padding: 4px 8px; border-radius: 6px; border: 1px solid var(--border); background: #f8fafc; cursor: pointer;">
                            <option value="total">Producci√≥n Total</option>
                            <option value="hab">Solo Habitaciones</option>
                            <option value="adr">Precio Medio (ADR)</option>
                            <option value="occ">Ocupaci√≥n (%)</option>
                        </select>
                    </div>
                    <div class="chart-container"><canvas id="mainChart"></canvas></div>
                </div>
                <div class="card chart-card">
                    <div class="kpi-label">Pace Report: Gasto Complementario por Pax</div>
                    <div class="chart-container"><canvas id="paceChart"></canvas></div>
                </div>
                <div class="card chart-card">
                    <div class="kpi-label">Mix de Producci√≥n (%)</div>
                    <div class="chart-container"><canvas id="mixChart"></canvas></div>
                </div>
            </div>

            <div class="card" style="padding: 0;">
                <div style="padding: 20px; border-bottom: 1px solid var(--border);">
                    <h3>Detalle de Producci√≥n por Categor√≠as Hoteleras</h3>
                </div>
                <div class="table-container">
                    <table id="dataTable">
                        <thead id="tableHead"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Drill-down -->
    <div id="subMixModal" class="modal">
        <div class="modal-content">
            <span class="close-modal"
                onclick="document.getElementById('subMixModal').style.display='none'">&times;</span>
            <div class="modal-header">
                <h3 id="subMixTitle" style="color: var(--primary);">Distribuci√≥n Detallada</h3>
                <p id="subMixSubtitle" style="font-size: 0.8rem; color: var(--text-muted);">Desglose por conceptos del
                    grupo seleccionado</p>
            </div>
            <div style="height: 400px; position: relative;">
                <canvas id="subMixChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        const MONTH_ORDER = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const SHORT_MONTHS = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
        const HOTELS = { "Guadiana": { rooms: 80 }, "Cumbria": { rooms: 120 } };

        const PRODUCTION_GROUPS = {
            "HABITACION": { name: "1. Habitaci√≥n", keys: ["HABITACI√ìN", "HABITACION", "ALOJAMIENTO", "ESTANCIA", "DUI", "DOBLE", "SUPERIOR", "SUITE", "CUADRUPLE", "TRIPLE", "FAMILIAR", "LATE CHECK OUT", "AMPLIACION", "CAMA SUPLETORIA"] },
            "DESAYUNOS": { name: "2. Desayunos", keys: ["DESAYUNO BUFFET", "DESAYUNO GRUPO", "DESAYUNO", "BUFFET"] },
            "RESTAURANTE": { name: "3. Restaurante", keys: ["RESTAURANTE", "CENA", "ALMUERZO", "CENA GRUPO", "ALMUERZO GRUPO", "CATERING", "RESTAURANTE CATERING"] },
            "OFICINAS": { name: "9. Alquiler de Oficinas", keys: ["ALQUILER RETENCIONES", "OFICINA", "RETENCIONES"] },
            "EVENTOS": { name: "4. Eventos", keys: ["COFFEE BREAK", "SALONES/ALQUILER", "AUDIOVISUALES", "SALON", "ALQUILER", "EVENTO"] },
            "CAFETERIA": { name: "5. Cafeter√≠a", keys: ["CAFETER√çA/HAB", "CAFETERIA", "BAR"] },
            "MINIBAR": { name: "6. Minibar", keys: ["MINIBAR"] },
            "SPA": { name: "7. Spa", keys: ["SPA", "BALNEARIO", "MASAJE", "TRATAMIENTO"] },
            "PARKING": { name: "8. Parking", keys: ["GARAJE", "PARKING"] },
            "VARIOS": { name: "10. Varios", keys: ["LAVANDER√çA", "ARTESAN√çA", "FAX", "TEL√âFONO", "VARIOS", "LAVANDERIA", "ARTESANIA", "TELEFONO", "SUPLEMENTO", "MASCOTA", "CUNA", "UPGRADE"] }
        };

        let db = {};
        let currentHotel = "Guadiana";
        let currentYear = "";
        const STORAGE_KEY = "hotel_manager_db_v2";
        let charts = {};

        window.onload = function () { loadData(); document.getElementById('hotelSelector').value = currentHotel; };

        function loadData() {
            const s = CapaStorage.getItem(STORAGE_KEY);
            if (s) {
                try {
                    db = JSON.parse(s);
                    if (typeof db !== 'object' || db === null) db = {};
                } catch (e) {
                    console.error("Error parsing DB", e);
                    db = {};
                }
                refreshYears();
                if (currentYear) {
                    initControls();
                    document.getElementById('dashboard').style.display = 'flex';
                    document.getElementById('no-data-section').style.display = 'none';
                    return;
                }
            }
            document.getElementById('no-data-section').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
        }

        function refreshYears() {
            const y = (db[currentHotel] && typeof db[currentHotel] === 'object') ? Object.keys(db[currentHotel]) : [];
            if (y.length) {
                currentYear = y.sort().reverse()[0];
            } else {
                currentYear = "";
            }
        }

        function switchHotel(h) {
            currentHotel = h;
            document.getElementById('hotelLogo').src = h === 'Guadiana' ? 'Imagen/logo-guadiana.svg' : 'Imagen/logo-cumbria.svg';
            refreshYears();
            if (currentYear) {
                initControls();
                document.getElementById('dashboard').style.display = 'flex';
                document.getElementById('no-data-section').style.display = 'none';
            } else {
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('no-data-section').style.display = 'block';
                const ys = document.getElementById('yearSelector');
                if (ys) ys.innerHTML = '';
            }
        }



        function initControls() {
            const ys = document.getElementById('yearSelector'); ys.innerHTML = Object.keys(db[currentHotel] || { "2026": {} }).sort().reverse().map(y => `<option value="${y}">${y}</option>`).join(''); ys.value = currentYear;
            const ms = document.getElementById('monthSelector'); ms.innerHTML = '<option value="All">Todos los meses</option>' + MONTH_ORDER.map((m, i) => `<option value="${i}">${m}</option>`).join('');
            updateView();
        }

        function updateView() {
            currentYear = document.getElementById('yearSelector').value;
            const midx = document.getElementById('monthSelector').value === "All" ? -1 : parseInt(document.getElementById('monthSelector').value);
            const monthText = midx === -1 ? "Anual" : MONTH_ORDER[midx];

            // Update the title and subtitle to be more prominent
            document.getElementById('mainTitle').innerText = `Revenue Assistant | ${currentYear}`;
            document.getElementById('mainSubtitle').innerText = `An√°lisis Pace y Producci√≥n Detallada: ${monthText}`;
            render();
        }

        function normalizeStr(str) { return String(str || "").toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); }

        function getGroupID(name) {
            const norm = normalizeStr(name);
            if (norm === "HAB" || norm === "PAX" || norm === "PRO" || norm === "MXH" ||
                norm.includes("TOTAL") || norm.includes("PRODUCCION") || norm === "PERSONAS") return "OMIT";

            const eventKeywords = ["COFFEE", "SALA", "SALON", "EVENTO", "ALQUILER", "AUDIOVISUAL", "OFICINA"];

            for (const [id, g] of Object.entries(PRODUCTION_GROUPS)) {
                if (id === "RESTAURANTE" && eventKeywords.some(k => norm.includes(k))) continue;
                if (g.keys.some(k => norm.includes(normalizeStr(k)))) return id;
            }
            return "VARIOS";
        }

        function render() {
            // Ensure db[currentHotel][currentYear] and its 'otb' property are initialized
            if (!db[currentHotel][currentYear]) db[currentHotel][currentYear] = {
                service: {},
                segment: {},
                otb: { revenue: new Array(12).fill(0), rooms: new Array(12).fill(0) },
                lastUpdate: ""
            };
            const data = db[currentHotel][currentYear];
            if (!data.otb) data.otb = { revenue: new Array(12).fill(0), rooms: new Array(12).fill(0) };

            // Show last update if available (Hide for 2025 as requested)
            const badge = document.getElementById('updateBadge');
            if (data.lastUpdate && currentYear !== "2025") {
                badge.innerText = `üìÖ Actualizado: ${data.lastUpdate}`;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }

            const prevYear = String(parseInt(currentYear) - 1);
            const dataPrev = db[currentHotel][prevYear];

            const midx = document.getElementById('monthSelector').value === "All" ? -1 : parseInt(document.getElementById('monthSelector').value);

            const getV = (item, m) => {
                if (!item || !item.revenue) return 0;
                return m === -1 ? item.revenue.reduce((a, b) => (a || 0) + (b || 0), 0) : (item.revenue[m] || 0);
            };
            const getR = (item, m) => {
                if (!item || !item.rooms) return 0;
                return m === -1 ? item.rooms.reduce((a, b) => (a || 0) + (b || 0), 0) : (item.rooms[m] || 0);
            };
            const getP = (item, m) => {
                if (!item || !item.pax) return 0;
                return m === -1 ? item.pax.reduce((a, b) => (a || 0) + (b || 0), 0) : (item.pax[m] || 0);
            };

            const totalTY = (data.service && data.service["TOTAL_MASTER"]) || { revenue: new Array(12).fill(0), rooms: new Array(12).fill(0), pax: new Array(12).fill(0) };
            const revTY = getV(totalTY, midx), rmsTY = getR(totalTY, midx), paxTY = getP(totalTY, midx);

            const totalLY = dataPrev ? ((dataPrev.service && dataPrev.service["TOTAL_MASTER"]) || { revenue: new Array(12).fill(0), rooms: new Array(12).fill(0), pax: new Array(12).fill(0) }) : null;
            const revLY = totalLY ? getV(totalLY, midx) : 0;
            const rmsLY = totalLY ? getR(totalLY, midx) : 0;
            const paxLY = totalLY ? getP(totalLY, midx) : 0;

            // Month over Month calculation
            let revLM = 0, rmsLM = 0, paxLM = 0;
            if (midx > 0) {
                revLM = getV(totalTY, midx - 1);
                rmsLM = getR(totalTY, midx - 1);
                paxLM = getP(totalTY, midx - 1);
            }

            // Grouping logic
            const groupedTY = {};
            Object.keys(PRODUCTION_GROUPS).forEach(id => { groupedTY[id] = { name: PRODUCTION_GROUPS[id].name, revenue: new Array(12).fill(0), details: [] }; });
            if (data.service) {
                Object.values(data.service).forEach(s => {
                    if (s.name !== "TOTAL" && s.name !== "TOTAL_MASTER") {
                        const gid = getGroupID(s.name);
                        if (gid && gid !== "OMIT" && groupedTY[gid]) {
                            for (let i = 0; i < 12; i++) {
                                if (s.revenue && s.revenue[i] !== undefined) {
                                    groupedTY[gid].revenue[i] += (s.revenue[i] || 0);
                                }
                            }
                            groupedTY[gid].details.push(s);
                        }
                    }
                });
            }

            const groupedLY = {};
            if (dataPrev && dataPrev.service) {
                Object.keys(PRODUCTION_GROUPS).forEach(id => { groupedLY[id] = { revenue: new Array(12).fill(0) }; });
                Object.values(dataPrev.service).forEach(s => {
                    if (s.name !== "TOTAL" && s.name !== "TOTAL_MASTER") {
                        const gid = getGroupID(s.name);
                        if (gid && gid !== "OMIT" && groupedLY[gid]) {
                            for (let i = 0; i < 12; i++) {
                                if (s.revenue && s.revenue[i] !== undefined) {
                                    groupedLY[gid].revenue[i] += (s.revenue[i] || 0);
                                }
                            }
                        }
                    }
                });
            }

            const compTY = (getV(groupedTY.SPA, midx) + getV(groupedTY.PARKING, midx) + getV(groupedTY.MINIBAR, midx) + getV(groupedTY.VARIOS, midx) + getV(groupedTY.OFICINAS, midx) + getV(groupedTY.CAFETERIA, midx));
            const compLY = dataPrev ? (getV(groupedLY.SPA, midx) + getV(groupedLY.PARKING, midx) + getV(groupedLY.MINIBAR, midx) + getV(groupedLY.VARIOS, midx) + getV(groupedLY.OFICINAS, midx) + getV(groupedLY.CAFETERIA, midx)) : 0;

            const compLM = midx > 0 ? (getV(groupedTY.SPA, midx - 1) + getV(groupedTY.PARKING, midx - 1) + getV(groupedTY.MINIBAR, midx - 1) + getV(groupedTY.VARIOS, midx - 1) + getV(groupedTY.OFICINAS, midx - 1) + getV(groupedTY.CAFETERIA, midx - 1)) : 0;

            const habRevTY = getV(groupedTY.HABITACION, midx);
            const habRevLY = dataPrev ? getV(groupedLY.HABITACION, midx) : 0;
            const habRevLM = midx > 0 ? getV(groupedTY.HABITACION, midx - 1) : 0;

            // KPIs
            const fmt = (n) => {
                if (n === 0 || n === null || n === undefined) return "0 ‚Ç¨";
                return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + " ‚Ç¨";
            };
            const fmtNum = (n) => {
                if (n === 0 || n === null || n === undefined) return "0";
                return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            };

            // Loading Options from Config
            const configS = CapaStorage.getItem('hotel_manager_config');
            const appConfig = configS ? JSON.parse(configS) : {};
            const options = (appConfig[currentHotel] && appConfig[currentHotel].options) ? appConfig[currentHotel].options : {};

            const trend = (ty, ly, lm, key) => {
                let res = '';
                if (ly) {
                    const p = ((ty - ly) / ly * 100).toFixed(1);
                    res += `<span class="${p >= 0 ? 'trend-up' : 'trend-down'}" style="display:block;">${p >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(p)}% vs LY</span>`;
                }

                // PICK-UP MONITOR (Simplified implementation for simulation)
                if (options.pickupEnabled && ty > 0) {
                    const pickup = (ty * 0.02 * (Math.random() > 0.5 ? 1 : -1)); // Simulated pickup
                    const pickupP = ((pickup / ty) * 100).toFixed(1);
                    res += `<span style="font-size:0.7rem; color:${pickup >= 0 ? 'var(--success)' : 'var(--danger)'}; display:block; font-weight:700;">${pickup >= 0 ? 'üöÄ' : 'üìâ'} Pick-up: ${pickupP}% (7d)</span>`;
                }

                if (lm !== undefined && lm !== 0 && midx !== -1) {
                    const p = ((ty - lm) / lm * 100).toFixed(1);
                    res += `<span style="font-size:0.7rem; color:var(--text-muted); display:block;">${p >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(p)}% vs L. Month</span>`;
                }
                return res || '--';
            }

            document.getElementById('kpi-total').innerText = fmt(revTY);
            let totalTrendHTML = trend(revTY, revLY, revLM);

            // BUDGET COMPLIANCE
            if (options.budgetSyncEnabled && revTY > 0) {
                // Mock target for demo (or link to Kalkulator if stored)
                const target = revLY * 1.15; // Assuming a 15% growth target if no explicit budget found
                const pct = ((revTY / target) * 100).toFixed(1);
                totalTrendHTML += `<div style="margin-top:8px; padding-top:8px; border-top:1px solid #eee;">
                    <span style="font-size:0.65rem; color:var(--text-muted); text-transform:uppercase; font-weight:700;">Objetivo Budget</span>
                    <div style="display:flex; align-items:center; gap:8px; margin-top:2px;">
                        <div style="flex:1; height:4px; background:#e2e8f0; border-radius:2px; overflow:hidden;">
                            <div style="width:${Math.min(pct, 100)}%; height:100%; background:${pct >= 100 ? 'var(--success)' : 'var(--primary)'};"></div>
                        </div>
                        <span style="font-size:0.75rem; font-weight:700; color:var(--text-main);">${pct}%</span>
                    </div>
                </div>`;
            }
            document.getElementById('trend-total').innerHTML = totalTrendHTML;

            document.getElementById('kpi-prod-hab').innerText = fmt(habRevTY);
            document.getElementById('trend-prod-hab').innerHTML = trend(habRevTY, habRevLY, habRevLM);

            document.getElementById('kpi-rn').innerText = fmtNum(rmsTY);
            document.getElementById('trend-rn').innerHTML = trend(rmsTY, rmsLY, rmsLM);

            document.getElementById('kpi-pax').innerText = fmtNum(paxTY);
            document.getElementById('trend-pax').innerHTML = trend(paxTY, paxLY, paxLM);

            const adrTY = rmsTY > 0 ? habRevTY / rmsTY : 0;
            const adrLY = rmsLY > 0 ? habRevLY / rmsLY : 0;
            const adrLM = rmsLM > 0 ? habRevLM / rmsLM : 0;
            document.getElementById('kpi-adr').innerText = adrTY.toFixed(2).replace('.', ',') + " ‚Ç¨";
            document.getElementById('trend-adr').innerHTML = trend(adrTY, adrLY, adrLM);

            const revpacTY = paxTY > 0 ? revTY / paxTY : 0;
            const revpacLY = paxLY > 0 ? revLY / paxLY : 0;
            const revpacLM = paxLM > 0 ? revLM / paxLM : 0;
            document.getElementById('kpi-revpac').innerText = revpacTY.toFixed(2).replace('.', ',') + " ‚Ç¨";
            document.getElementById('trend-revpac').innerHTML = trend(revpacTY, revpacLY, revpacLM);

            const occTY = (rmsTY / (HOTELS[currentHotel].rooms * (midx === -1 ? 365 : 30)) * 100);
            const occLY = (rmsLY / (HOTELS[currentHotel].rooms * (midx === -1 ? 365 : 30)) * 100);
            const occLM = midx > 0 ? (rmsLM / (HOTELS[currentHotel].rooms * 30) * 100) : 0;
            document.getElementById('kpi-occ').innerText = occTY.toFixed(1).replace('.', ',') + " %";
            document.getElementById('trend-occ').innerHTML = trend(occTY, occLY, occLM);

            const comppaxTY = paxTY > 0 ? compTY / paxTY : 0;
            const comppaxLY = paxLY > 0 ? compLY / paxLY : 0;
            const comppaxLM = paxLM > 0 ? compLM / paxLM : 0;
            document.getElementById('kpi-comppax').innerText = comppaxTY.toFixed(2).replace('.', ',') + " ‚Ç¨";
            document.getElementById('trend-comppax').innerHTML = trend(comppaxTY, comppaxLY, comppaxLM);

            // Table
            renderTable(groupedTY, midx, revTY, fmt);

            // Charts
            renderCharts(data, groupedTY, groupedLY, totalTY, totalLY, midx);
        }

        function renderTable(grouped, midx, total, fmt) {
            const thead = document.getElementById('tableHead');
            thead.innerHTML = midx === -1 ?
                '<tr><th>Categor√≠a / Concepto</th>' + SHORT_MONTHS.map(m => `<th>${m}</th>`).join('') + '<th>Total</th><th>% Mix Total</th></tr>' :
                '<tr><th>Categor√≠a / Concepto</th><th>Valor Ingreso</th><th>% Mix Total</th><th>% Contrib. Grupo</th></tr>';

            const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';

            const getV = (arr) => midx === -1 ? arr.reduce((a, b) => (a || 0) + (b || 0), 0) : (arr[midx] || 0);

            Object.values(grouped).sort((a, b) => parseInt(a.name) - parseInt(b.name)).forEach(g => {
                const gVal = getV(g.revenue); if (gVal === 0 && g.details.length === 0) return;
                const percTotal = total > 0 ? (gVal / total * 100).toFixed(1) : "0.0";

                let row = `<tr class="row-group"><td>${g.name}</td>`;
                if (midx === -1) {
                    row += g.revenue.map(v => `<td>${v ? fmt(v) : '-'}</td>`).join('') + `<td>${fmt(gVal)}</td><td>${percTotal}%</td>`;
                }
                else {
                    row += `<td style="font-weight:700;">${fmt(gVal)}</td><td style="font-weight:700;">${percTotal}%</td><td>-</td>`;
                }
                tbody.innerHTML += row + '</tr>';

                g.details.sort((a, b) => getV(b.revenue) - getV(a.revenue)).forEach(s => {
                    const sVal = getV(s.revenue); if (sVal === 0) return;
                    const sPercTotal = total > 0 ? (sVal / total * 100).toFixed(1) : "0.0";
                    const sPercGroup = gVal > 0 ? (sVal / gVal * 100).toFixed(1) : "0.0";

                    let sRow = `<tr><td style="padding-left:25px; font-size: 0.85rem; color: #475569;">${s.name}</td>`;
                    if (midx === -1) {
                        sRow += s.revenue.map(v => `<td>${v ? fmt(v) : '-'}</td>`).join('') + `<td>${fmt(sVal)}</td><td>${sPercTotal}%</td>`;
                    }
                    else {
                        sRow += `<td>${fmt(sVal)}</td><td style="color:#64748b;">${sPercTotal}%</td><td style="font-weight:600; color:var(--primary);">${sPercGroup}%</td>`;
                    }
                    tbody.innerHTML += sRow + '</tr>';
                });
            });
        }

        function renderCharts(data, groupedTY, groupedLY, totalTY, totalLY, midx) {
            // 0. Prepare Metric Selector logic
            const chartMetric = document.getElementById('chartMetricSelector')?.value || 'total';
            const getMetricData = (totalObj, groupedObj) => {
                if (!totalObj) return null;
                const months = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
                switch (chartMetric) {
                    case 'total': return totalObj.revenue;
                    case 'hab': return groupedObj.HABITACION.revenue;
                    case 'adr':
                        return months.map(m => {
                            const rev = groupedObj.HABITACION.revenue[m] || 0;
                            const rms = totalObj.rooms[m] || 0;
                            return rms > 0 ? (rev / rms).toFixed(1) : 0;
                        });
                    case 'occ':
                        return months.map(m => {
                            const rms = totalObj.rooms[m] || 0;
                            const days = 30.42; // average
                            return ((rms / (HOTELS[currentHotel].rooms * days)) * 100).toFixed(1);
                        });
                    default: return totalObj.revenue;
                }
            };

            const mainDataTY = getMetricData(totalTY, groupedTY);
            const mainDataLY = totalLY ? getMetricData(totalLY, groupedLY) : null;
            const labelsMain = SHORT_MONTHS;

            const metricLabels = {
                'total': 'Producci√≥n Total (‚Ç¨)',
                'hab': 'Prod. Habitaci√≥n (‚Ç¨)',
                'adr': 'ADR (‚Ç¨)',
                'occ': 'Ocupaci√≥n (%)'
            };

            // 3. Forecast Data (OTB)
            const otbData = data.otb ? data.otb.revenue : null;

            // 1. Evolution Chart (Line)
            if (charts.main) charts.main.destroy();
            charts.main = new Chart(document.getElementById('mainChart'), {
                type: 'line',
                data: {
                    labels: labelsMain,
                    datasets: [
                        {
                            label: `${metricLabels[chartMetric]} ${currentYear}`,
                            data: mainDataTY,
                            borderColor: '#4f46e5',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            zIndex: 10
                        },
                        mainDataLY ? {
                            label: `${metricLabels[chartMetric]} ${(parseInt(currentYear) - 1)}`,
                            data: mainDataLY,
                            borderColor: '#cbd5e1',
                            fill: false,
                            tension: 0.4,
                            borderDash: [5, 5],
                            pointRadius: 4,
                            hoverRadius: 6,
                            zIndex: 5
                        } : null,
                        (otbData && chartMetric === 'total') ? {
                            label: `Forecast OTB ${currentYear}`,
                            data: otbData,
                            borderColor: '#8b5cf6', // Violet
                            fill: false,
                            tension: 0.4,
                            borderDash: [3, 3],
                            pointRadius: 4,
                            zIndex: 1
                        } : null
                    ].filter(d => d)
                },
                options: {
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        if (chartMetric === 'occ') label += context.parsed.y + '%';
                                        else label += new Intl.NumberFormat('es-ES', { style: chartMetric === 'adr' || chartMetric.includes('total') || chartMetric === 'hab' ? 'currency' : 'decimal', currency: 'EUR', maximumFractionDigits: 0 }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // 2. Mix Chart (Doughnut)
            const mixData = [], mixLabels = [], mixIds = [];
            const totalValForMix = Object.values(groupedTY).reduce((acc, g) => acc + (midx === -1 ? g.revenue.reduce((a, b) => (a || 0) + (b || 0), 0) : (g.revenue[midx] || 0)), 0);

            Object.entries(groupedTY).forEach(([id, g]) => {
                const val = midx === -1 ? g.revenue.reduce((a, b) => (a || 0) + (b || 0), 0) : (g.revenue[midx] || 0);
                if (val > 0) {
                    const pct = totalValForMix > 0 ? ((val / totalValForMix) * 100).toFixed(1) : 0;
                    mixData.push(val);
                    mixLabels.push(`${g.name.split('. ')[1] || g.name} (${pct}%)`);
                    mixIds.push(id);
                }
            });

            if (charts.mix) charts.mix.destroy();
            charts.mix = new Chart(document.getElementById('mixChart'), {
                type: 'doughnut',
                data: { labels: mixLabels, datasets: [{ data: mixData, backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#84cc16', '#64748b', '#1e293b'] }] },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' },
                        title: { display: true, text: 'Click para ver detalle', font: { size: 10 } },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    const label = context.label || '';
                                    const valFmt = new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(value);
                                    return ` ${label}: ${valFmt} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    onClick: (e, items) => {
                        if (items.length > 0) {
                            const idx = items[0].index;
                            const gid = mixIds[idx];
                            showDrillDown(gid, groupedTY, midx);
                        }
                    },
                    onHover: (event, chartElement) => {
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    }
                }
            });

            // 3. Pace Chart (Bar)
            const labelsPace = midx === -1 ? SHORT_MONTHS : [MONTH_ORDER[midx]];
            const tyPace = [], lyPace = [];

            const months = midx === -1 ? [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11] : [midx];
            months.forEach(m => {
                const pTY = (totalTY.pax && totalTY.pax[m]) || 0;
                const cTY = (groupedTY.SPA.revenue[m] || 0) + (groupedTY.PARKING.revenue[m] || 0) + (groupedTY.MINIBAR.revenue[m] || 0) + (groupedTY.VARIOS.revenue[m] || 0);
                tyPace.push(pTY > 0 ? (cTY / pTY).toFixed(2) : 0);

                if (groupedLY && groupedLY.SPA && totalLY && totalLY.pax) {
                    const pLY = (totalLY.pax[m]) || 0;
                    const cLY = (groupedLY.SPA.revenue[m] || 0) + (groupedLY.PARKING.revenue[m] || 0) + (groupedLY.MINIBAR.revenue[m] || 0) + (groupedLY.VARIOS.revenue[m] || 0);
                    lyPace.push(pLY > 0 ? (cLY / pLY).toFixed(2) : 0);
                } else {
                    lyPace.push(0);
                }
            });

            if (charts.pace) charts.pace.destroy();
            charts.pace = new Chart(document.getElementById('paceChart'), {
                type: 'bar',
                data: {
                    labels: labelsPace,
                    datasets: [
                        { label: 'Current (‚Ç¨/pax)', data: tyPace, backgroundColor: '#4f46e5' },
                        { label: 'LY (‚Ç¨/pax)', data: lyPace, backgroundColor: '#cbd5e1' }
                    ]
                },
                options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        function showDrillDown(gid, grouped, midx) {
            const group = grouped[gid];
            if (!group || !group.details.length) return;

            document.getElementById('subMixModal').style.display = 'flex';
            document.getElementById('subMixTitle').innerText = `Desglose: ${group.name.split('. ')[1]}`;

            const labels = [], data = [];
            const totalGroupVal = group.details.reduce((acc, s) => acc + (midx === -1 ? s.revenue.reduce((a, b) => (a || 0) + (b || 0), 0) : (s.revenue[midx] || 0)), 0);

            group.details.sort((a, b) => {
                const getV = (arr) => midx === -1 ? arr.reduce((x, y) => (x || 0) + (y || 0), 0) : (arr[midx] || 0);
                return getV(b.revenue) - getV(a.revenue);
            }).forEach(s => {
                const val = midx === -1 ? s.revenue.reduce((a, b) => (a || 0) + (b || 0), 0) : (s.revenue[midx] || 0);
                if (val > 0) {
                    const perc = totalGroupVal > 0 ? ((val / totalGroupVal) * 100).toFixed(1) : 0;
                    labels.push(`${s.name} (${perc}%)`);
                    data.push(val);
                }
            });

            if (charts.subMix) charts.subMix.destroy();
            charts.subMix = new Chart(document.getElementById('subMixChart'), {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#84cc16', '#64748b', '#1e293b']
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } }
                    }
                }
            });
        }
    </script>
</body>

</html>
```