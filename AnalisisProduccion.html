<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis de Producci√≥n | CapaSuite</title>
    <link rel="icon" type="image/png" href="Imagen/Icono_CapaSuite.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="Imagen/Icono_CapaSuite.png">
    <script src="js/chart.js"></script>
    <script src="js/storage.js"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #3730a3;
            --bg-body: #f8fafc;
            --bg-surface: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --radius: 12px;
            --success: #10b981;
            --warning: #f59e0b;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 15px;
            font-size: 13px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: var(--bg-surface);
            padding: 20px 30px;
            border-radius: var(--radius);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .title h1 {
            font-size: 1.5rem;
            margin: 0;
            color: var(--primary-dark);
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            position: relative;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 24px;
        }

        .kpi-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .kpi-value {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .kpi-trend {
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .trend-up {
            color: var(--success);
        }

        .trend-down {
            color: #ef4444;
        }

        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .chart-card {
            display: flex;
            flex-direction: column;
            height: 400px;
        }

        .chart-container {
            flex: 1;
            position: relative;
            min-height: 0;
        }

        .table-container {
            overflow: auto;
            max-height: 500px;
            border-radius: var(--radius);
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap;
        }

        th,
        td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            text-align: right;
            font-size: 0.85rem;
        }

        th {
            background: #f1f5f9;
            color: var(--text-muted);
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.7rem;
            text-transform: uppercase;
        }

        th:first-child,
        td:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: inherit;
            z-index: 11;
            font-weight: 600;
        }

        .row-group {
            background: #f8fafc;
            font-weight: 700;
            color: var(--primary);
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .upload-area {
            background: var(--bg-surface);
            border: 2px dashed #cbd5e1;
            border-radius: 16px;
            padding: 60px;
            text-align: center;
            cursor: pointer;
        }

        .loader {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="header">
            <div style="display: flex; align-items: center; gap: 20px;">
                <a href="index.html"><img src="Imagen/logo, CapaSuite.png" alt="CapaSuite" style="height: 50px;"></a>
                <img id="hotelLogo" src="Imagen/logo-guadiana.svg" alt="Logo Hotel" style="height: 45px;">
                <div class="title">
                    <h1>Revenue Assistant</h1>
                    <p>An√°lisis Pace y Producci√≥n Detallada</p>
                </div>
            </div>
            <div style="display:flex; gap:12px; align-items:center;">
                <select id="yearSelector" onchange="updateView()"
                    style="padding:10px; border-radius:8px; border:1px solid #e2e8f0;"></select>
                <select id="monthSelector" onchange="updateView()"
                    style="padding:10px; border-radius:8px; border:1px solid #e2e8f0;"></select>
                <select id="hotelSelector" onchange="switchHotel(this.value)"
                    style="padding:10px; border-radius:8px; border:1px solid #e2e8f0; font-weight:600;">
                    <option value="Guadiana">Hotel Guadiana</option>
                    <option value="Cumbria">Hotel Cumbria</option>
                </select>
            </div>
        </header>

        <div id="no-data-section" class="upload-area" style="display:none;">
            <div style="font-size: 3rem; margin-bottom: 20px;">üõ°Ô∏è</div>
            <h2>No se han encontrado datos</h2>
            <p>Por favor, utiliza el m√≥dulo de <b>Carga de Datos</b> para importar tus informes.</p>
            <a href="CargarDatos.html" class="btn"
                style="display:inline-block; text-decoration:none; margin-top:20px;">Ir a Carga de Datos</a>
        </div>

        <div id="loader" class="loader"></div>

        <div id="dashboard" style="display:none; flex-direction:column; gap:24px;">
            <div class="kpi-grid">
                <div class="card" style="border-left: 4px solid var(--primary);">
                    <div class="kpi-label">Producci√≥n Total</div>
                    <div class="kpi-value" id="kpi-total">0 ‚Ç¨</div>
                    <div class="kpi-trend" id="trend-total">--</div>
                </div>
                <div class="card">
                    <div class="kpi-label">ADR (Habitaci√≥n)</div>
                    <div class="kpi-value" id="kpi-adr">0 ‚Ç¨</div>
                    <div class="kpi-trend" id="trend-adr">--</div>
                </div>
                <div class="card">
                    <div class="kpi-label">RevPAC (Total/Pax)</div>
                    <div class="kpi-value" id="kpi-revpac">0 ‚Ç¨</div>
                    <div class="kpi-trend" id="trend-revpac">--</div>
                </div>
                <div class="card">
                    <div class="kpi-label">Ticket Desayuno</div>
                    <div class="kpi-value" id="kpi-ticketdes">0 ‚Ç¨</div>
                    <div class="kpi-trend" id="trend-ticketdes">--</div>
                </div>
                <div class="card">
                    <div class="kpi-label">Ticket Comp.</div>
                    <div class="kpi-value" id="kpi-comppax">0 ‚Ç¨</div>
                    <div class="kpi-trend" id="trend-comppax">--</div>
                </div>
                <div class="card">
                    <div class="kpi-label">Ocupaci√≥n</div>
                    <div class="kpi-value" id="kpi-occ">0 %</div>
                    <div class="kpi-trend" id="trend-occ">--</div>
                </div>
            </div>

            <div class="charts-row">
                <div class="card chart-card">
                    <div class="kpi-label">Pace Report: Gasto Complementario por Pax (TY vs LY)</div>
                    <div class="chart-container"><canvas id="paceChart"></canvas></div>
                </div>
                <div class="card chart-card">
                    <div class="kpi-label">Mix de Producci√≥n (%)</div>
                    <div class="chart-container"><canvas id="mixChart"></canvas></div>
                </div>
            </div>

            <div class="card" style="padding: 0;">
                <div style="padding: 20px; border-bottom: 1px solid var(--border);">
                    <h3>Detalle de Producci√≥n por Categor√≠as Hoteleras</h3>
                </div>
                <div class="table-container">
                    <table id="dataTable">
                        <thead id="tableHead"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const MONTH_ORDER = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const SHORT_MONTHS = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
        const HOTELS = { "Guadiana": { rooms: 80 }, "Cumbria": { rooms: 120 } };

        const PRODUCTION_GROUPS = {
            "HABITACION": { name: "1. Habitaci√≥n", keys: ["HABITACI√ìN", "HABITACION", "ALOJAMIENTO", "ESTANCIA", "DUI", "DOBLE", "SUPERIOR", "SUITE", "CUADRUPLE", "TRIPLE", "FAMILIAR", "LATE CHECK OUT", "AMPLIACION", "CAMA SUPLETORIA"] },
            "DESAYUNOS": { name: "2. Desayunos", keys: ["DESAYUNO BUFFET", "DESAYUNO GRUPO", "DESAYUNO", "BUFFET"] },
            "RESTAURANTE": { name: "3. Restaurante", keys: ["RESTAURANTE", "CENA", "ALMUERZO", "CENA GRUPO", "ALMUERZO GRUPO", "CATERING", "RESTAURANTE CATERING"] },
            "OFICINAS": { name: "9. Alquiler de Oficinas", keys: ["ALQUILER RETENCIONES", "OFICINA", "RETENCIONES"] },
            "EVENTOS": { name: "4. Eventos", keys: ["COFFEE BREAK", "SALONES/ALQUILER", "AUDIOVISUALES", "SALON", "ALQUILER", "EVENTO"] },
            "CAFETERIA": { name: "5. Cafeter√≠a", keys: ["CAFETER√çA/HAB", "CAFETERIA", "BAR"] },
            "MINIBAR": { name: "6. Minibar", keys: ["MINIBAR"] },
            "SPA": { name: "7. Spa", keys: ["SPA", "BALNEARIO", "MASAJE", "TRATAMIENTO"] },
            "PARKING": { name: "8. Parking", keys: ["GARAJE", "PARKING"] },
            "VARIOS": { name: "10. Varios", keys: ["LAVANDER√çA", "ARTESAN√çA", "FAX", "TEL√âFONO", "VARIOS", "LAVANDERIA", "ARTESANIA", "TELEFONO", "SUPLEMENTO", "MASCOTA", "CUNA", "UPGRADE"] }
        };

        let db = {};
        let currentHotel = "Guadiana";
        let currentYear = "";
        const STORAGE_KEY = "hotel_manager_db_v2";
        let charts = {};

        window.onload = function () { loadData(); document.getElementById('hotelSelector').value = currentHotel; };

        function loadData() {
            const s = CapaStorage.getItem(STORAGE_KEY);
            if (s) {
                try {
                    db = JSON.parse(s);
                    if (typeof db !== 'object' || db === null) db = {};
                } catch (e) {
                    console.error("Error parsing DB", e);
                    db = {};
                }
                refreshYears();
                if (currentYear) {
                    initControls();
                    document.getElementById('dashboard').style.display = 'flex';
                    document.getElementById('no-data-section').style.display = 'none';
                    return;
                }
            }
            document.getElementById('no-data-section').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
        }

        function refreshYears() {
            const y = (db[currentHotel] && typeof db[currentHotel] === 'object') ? Object.keys(db[currentHotel]) : [];
            if (y.length) {
                currentYear = y.sort().reverse()[0];
            } else {
                currentYear = "";
            }
        }

        function switchHotel(h) {
            currentHotel = h;
            document.getElementById('hotelLogo').src = h === 'Guadiana' ? 'Imagen/logo-guadiana.svg' : 'Imagen/logo-cumbria.svg';
            refreshYears();
            if (currentYear) {
                initControls();
                document.getElementById('dashboard').style.display = 'flex';
                document.getElementById('no-data-section').style.display = 'none';
            } else {
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('no-data-section').style.display = 'block';
                const ys = document.getElementById('yearSelector');
                if (ys) ys.innerHTML = '';
            }
        }



        function initControls() {
            const ys = document.getElementById('yearSelector'); ys.innerHTML = Object.keys(db[currentHotel] || { "2026": {} }).sort().reverse().map(y => `<option value="${y}">${y}</option>`).join(''); ys.value = currentYear;
            const ms = document.getElementById('monthSelector'); ms.innerHTML = '<option value="All">Todos los meses</option>' + MONTH_ORDER.map((m, i) => `<option value="${i}">${m}</option>`).join('');
            updateView();
        }

        function updateView() { currentYear = document.getElementById('yearSelector').value; render(); }

        function normalizeStr(str) { return String(str || "").toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); }

        function getGroupID(name) {
            const norm = normalizeStr(name);
            if (norm === "HAB" || norm === "PAX" || norm === "PRO" || norm === "MXH" ||
                norm.includes("TOTAL") || norm.includes("PRODUCCION") || norm === "PERSONAS") return "OMIT";

            const eventKeywords = ["COFFEE", "SALA", "SALON", "EVENTO", "ALQUILER", "AUDIOVISUAL", "OFICINA"];

            for (const [id, g] of Object.entries(PRODUCTION_GROUPS)) {
                // Priority exclusion: Restaurant should not pick up Event-related keywords
                if (id === "RESTAURANTE" && eventKeywords.some(k => norm.includes(k))) continue;
                if (g.keys.some(k => norm.includes(normalizeStr(k)))) return id;
            }
            return "VARIOS";
        }

        function render() {
            const data = db[currentHotel][currentYear]; if (!data) return;
            const prevYear = String(parseInt(currentYear) - 1);
            const dataPrev = db[currentHotel][prevYear];

            const midx = document.getElementById('monthSelector').value === "All" ? -1 : parseInt(document.getElementById('monthSelector').value);
            const getV = (item, m) => {
                if (!item || !item.revenue) return 0;
                return m === -1 ? item.revenue.reduce((a, b) => a + b, 0) : item.revenue[m];
            };
            const getR = (item, m) => {
                if (!item || !item.rooms) return 0;
                return m === -1 ? item.rooms.reduce((a, b) => a + b, 0) : item.rooms[m];
            };
            const getP = (item, m) => {
                if (!item || !item.pax) return 0;
                return m === -1 ? item.pax.reduce((a, b) => a + b, 0) : item.pax[m];
            };

            const totalTY = data.service["TOTAL_MASTER"] || { revenue: new Array(12).fill(0), rooms: new Array(12).fill(0), pax: new Array(12).fill(0) };
            const revTY = getV(totalTY, midx), rmsTY = getR(totalTY, midx), paxTY = getP(totalTY, midx);

            const totalLY = dataPrev ? (dataPrev.service["TOTAL_MASTER"] || { revenue: new Array(12).fill(0), rooms: new Array(12).fill(0), pax: new Array(12).fill(0) }) : null;
            const revLY = totalLY ? getV(totalLY, midx) : 0;
            const rmsLY = totalLY ? getR(totalLY, midx) : 0;
            const paxLY = totalLY ? getP(totalLY, midx) : 0;

            // Grouping logic
            const groupedTY = {};
            Object.keys(PRODUCTION_GROUPS).forEach(id => { groupedTY[id] = { name: PRODUCTION_GROUPS[id].name, revenue: new Array(12).fill(0), details: [] }; });
            Object.values(data.service).forEach(s => {
                if (s.name !== "TOTAL" && s.name !== "TOTAL_MASTER") {
                    const gid = getGroupID(s.name);
                    if (gid && gid !== "OMIT" && groupedTY[gid]) {
                        for (let i = 0; i < 12; i++) {
                            if (s.revenue && s.revenue[i] !== undefined) {
                                groupedTY[gid].revenue[i] += s.revenue[i];
                            }
                        }
                        groupedTY[gid].details.push(s);
                    }
                }
            });

            const groupedLY = {};
            if (dataPrev) {
                Object.keys(PRODUCTION_GROUPS).forEach(id => { groupedLY[id] = { revenue: new Array(12).fill(0) }; });
                Object.values(dataPrev.service).forEach(s => {
                    if (s.name !== "TOTAL" && s.name !== "TOTAL_MASTER") {
                        const gid = getGroupID(s.name);
                        if (gid && gid !== "OMIT" && groupedLY[gid]) {
                            for (let i = 0; i < 12; i++) {
                                if (s.revenue && s.revenue[i] !== undefined) {
                                    groupedLY[gid].revenue[i] += s.revenue[i];
                                }
                            }
                        }
                    }
                });
            }

            const compTY = (getV(groupedTY.SPA, midx) + getV(groupedTY.PARKING, midx) + getV(groupedTY.MINIBAR, midx) + getV(groupedTY.VARIOS, midx) + getV(groupedTY.OFICINAS, midx) + getV(groupedTY.CAFETERIA, midx));
            const compLY = dataPrev ? (getV(groupedLY.SPA, midx) + getV(groupedLY.PARKING, midx) + getV(groupedLY.MINIBAR, midx) + getV(groupedLY.VARIOS, midx) + getV(groupedLY.OFICINAS, midx) + getV(groupedLY.CAFETERIA, midx)) : 0;

            const desTY = getV(groupedTY.DESAYUNOS, midx);
            const desLY = dataPrev ? getV(groupedLY.DESAYUNOS, midx) : 0;

            const habRevTY = getV(groupedTY.HABITACION, midx);
            const habRevLY = dataPrev ? getV(groupedLY.HABITACION, midx) : 0;

            // KPIs
            const fmt = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(n);
            const trend = (ty, ly) => {
                if (!ly) return "--";
                const p = ((ty - ly) / ly * 100).toFixed(1);
                return `<span class="${p >= 0 ? 'trend-up' : 'trend-down'}">${p >= 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(p)}% vs LY</span>`;
            }

            document.getElementById('kpi-total').innerText = fmt(revTY);
            document.getElementById('trend-total').innerHTML = trend(revTY, revLY);

            const adrTY = rmsTY > 0 ? habRevTY / rmsTY : 0;
            const adrLY = rmsLY > 0 ? habRevLY / rmsLY : 0;
            document.getElementById('kpi-adr').innerText = adrTY.toFixed(1) + " ‚Ç¨";
            document.getElementById('trend-adr').innerHTML = trend(adrTY, adrLY);

            const revpacTY = paxTY > 0 ? revTY / paxTY : 0;
            const revpacLY = paxLY > 0 ? revLY / paxLY : 0;
            document.getElementById('kpi-revpac').innerText = revpacTY.toFixed(1) + " ‚Ç¨";
            document.getElementById('trend-revpac').innerHTML = trend(revpacTY, revpacLY);

            const tktDesTY = paxTY > 0 ? desTY / paxTY : 0;
            const tktDesLY = paxLY > 0 ? desLY / paxLY : 0;
            if (document.getElementById('kpi-ticketdes')) document.getElementById('kpi-ticketdes').innerText = tktDesTY.toFixed(1) + " ‚Ç¨";
            if (document.getElementById('trend-ticketdes')) document.getElementById('trend-ticketdes').innerHTML = trend(tktDesTY, tktDesLY);

            const comppaxTY = paxTY > 0 ? compTY / paxTY : 0;
            const comppaxLY = paxLY > 0 ? compLY / paxLY : 0;
            document.getElementById('kpi-comppax').innerText = comppaxTY.toFixed(1) + " ‚Ç¨";
            document.getElementById('trend-comppax').innerHTML = trend(comppaxTY, comppaxLY);

            const occTY = (rmsTY / (HOTELS[currentHotel].rooms * (midx === -1 ? 365 : 30)) * 100);
            const occLY = (rmsLY / (HOTELS[currentHotel].rooms * (midx === -1 ? 365 : 30)) * 100);
            document.getElementById('kpi-occ').innerText = occTY.toFixed(1) + " %";
            document.getElementById('trend-occ').innerHTML = trend(occTY, occLY);

            // Table
            renderTable(groupedTY, midx, revTY, fmt);

            // Charts
            renderCharts(groupedTY, groupedLY, totalTY, totalLY, midx);
        }

        function renderTable(grouped, midx, total, fmt) {
            const thead = document.getElementById('tableHead'); thead.innerHTML = midx === -1 ? '<tr><th>Categor√≠a / Concepto</th>' + SHORT_MONTHS.map(m => `<th>${m}</th>`).join('') + '<th>Total</th></tr>' : '<tr><th>Categor√≠a / Concepto</th><th>Ingreso</th><th>% Mix</th></tr>';
            const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';

            const getV = (arr) => midx === -1 ? arr.reduce((a, b) => a + b, 0) : arr[midx];

            Object.values(grouped).sort((a, b) => parseInt(a.name) - parseInt(b.name)).forEach(g => {
                const gVal = getV(g.revenue); if (gVal === 0 && g.details.length === 0) return;
                let row = `<tr class="row-group"><td>${g.name}</td>`;
                if (midx === -1) { row += g.revenue.map(v => `<td>${v ? new Intl.NumberFormat('es-ES').format(v) : '-'}</td>`).join('') + `<td>${fmt(gVal)}</td>`; }
                else { row += `<td>${fmt(gVal)}</td><td>${(gVal / total * 100).toFixed(1)}%</td>`; }
                tbody.innerHTML += row + '</tr>';

                g.details.sort((a, b) => getV(b.revenue) - getV(a.revenue)).forEach(s => {
                    const sVal = getV(s.revenue); if (sVal === 0) return;
                    let sRow = `<tr><td style="padding-left:15px; font-size: 0.8rem; color: #475569;">${s.name}</td>`;
                    if (midx === -1) { sRow += s.revenue.map(v => `<td>${v ? new Intl.NumberFormat('es-ES').format(v) : '-'}</td>`).join('') + `<td>${new Intl.NumberFormat('es-ES', { maximumFractionDigits: 0 }).format(sVal)} ‚Ç¨</td>`; }
                    else { sRow += `<td>${new Intl.NumberFormat('es-ES', { maximumFractionDigits: 0 }).format(sVal)} ‚Ç¨</td><td>${(sVal / total * 100).toFixed(1)}%</td>`; }
                    tbody.innerHTML += sRow + '</tr>';
                });
            });
        }

        function renderCharts(groupedTY, groupedLY, totalTY, totalLY, midx) {
            // Mix Chart
            const mixData = [], mixLabels = [];
            Object.values(groupedTY).forEach(g => {
                const val = midx === -1 ? g.revenue.reduce((a, b) => a + b, 0) : g.revenue[midx];
                if (val > 0) { mixData.push(val); mixLabels.push(g.name.split('. ')[1]); }
            });

            if (charts.mix) charts.mix.destroy();
            charts.mix = new Chart(document.getElementById('mixChart'), {
                type: 'doughnut',
                data: { labels: mixLabels, datasets: [{ data: mixData, backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#84cc16', '#64748b', '#1e293b'] }] },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });

            // Pace Chart: Complementary / Pax comparison
            const labels = midx === -1 ? SHORT_MONTHS : [MONTH_ORDER[midx]];
            const tyPace = [], lyPace = [];

            const months = midx === -1 ? [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11] : [midx];
            months.forEach(m => {
                const paxTY = totalTY.pax[m] || 0;
                const compTY = groupedTY.SPA.revenue[m] + groupedTY.PARKING.revenue[m] + groupedTY.MINIBAR.revenue[m] + groupedTY.VARIOS.revenue[m];
                tyPace.push(paxTY > 0 ? (compTY / paxTY).toFixed(2) : 0);

                if (groupedLY && totalLY) {
                    const paxLY = totalLY.pax[m] || 0;
                    const compLY = groupedLY.SPA.revenue[m] + groupedLY.PARKING.revenue[m] + groupedLY.MINIBAR.revenue[m] + groupedLY.VARIOS.revenue[m];
                    lyPace.push(paxLY > 0 ? (compLY / paxLY).toFixed(2) : 0);
                } else {
                    lyPace.push(0);
                }
            });

            if (charts.pace) charts.pace.destroy();
            charts.pace = new Chart(document.getElementById('paceChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'This Year (‚Ç¨/pax)', data: tyPace, backgroundColor: '#4f46e5' },
                        { label: 'Last Year (‚Ç¨/pax)', data: lyPace, backgroundColor: '#cbd5e1' }
                    ]
                },
                options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Euros por Pax' } } } }
            });
        }
    </script>
</body>

</html>