<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis de Segmentos | CapaSuite</title>
    <link rel="icon" type="image/png" href="Imagen/Icono_CapaSuite.png">
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Libraries -->
    <script src="js/xlsx.full.min.js"></script>
    <script src="js/chart.js"></script>
    <script src="js/storage.js"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #3730a3;
            --primary-light: #eef2ff;
            --bg-body: #f8fafc;
            --bg-surface: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --radius: 12px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 30px;
            font-size: 14px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* HEADER */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: var(--bg-surface);
            padding: 20px 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
        }

        .title h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
            color: var(--primary-dark);
        }

        .title p {
            margin: 4px 0 0;
            color: var(--text-muted);
        }

        /* UPLOAD */
        .upload-area {
            background: var(--bg-surface);
            border: 2px dashed #cbd5e1;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 30px;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn:hover {
            background: var(--primary-dark);
        }

        /* DASHBOARD */
        .dashboard {
            display: none;
            /* Hidden by default */
            flex-direction: column;
            gap: 24px;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--bg-surface);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
        }

        .kpi-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .kpi-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .kpi-diff {
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 4px;
        }

        .diff.up {
            color: var(--success);
        }

        .diff.down {
            color: var(--danger);
        }

        /* METRIC INDICATOR */
        .metric-indicator {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 16px 24px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: var(--shadow-md);
        }

        .metric-icon {
            font-size: 2rem;
        }

        .metric-name {
            font-size: 1.5rem;
            font-weight: 700;
            flex: 1;
        }

        .metric-years {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .charts-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 20px;
            height: 350px;
        }

        .charts-row .card {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chart-container {
            flex: 1;
            position: relative;
            width: 100%;
            min-height: 0;
        }

        .table-container {
            overflow: auto;
            max-height: 500px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            background: var(--bg-surface);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap;
        }

        th,
        td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            text-align: right;
        }

        th {
            background: #f1f5f9;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th:first-child,
        td:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: inherit;
            z-index: 11;
            font-weight: 600;
            border-right: 1px solid var(--border);
        }

        tr:hover td {
            background-color: #f8fafc;
        }

        .row-total {
            background: #f8fafc !important;
            font-weight: 700;
        }

        .perc-column {
            color: var(--text-muted);
            font-size: 0.8rem;
            font-style: italic;
        }

        .loader {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* TOP NAVIGATION */
        .top-nav {
            background: #1e293b;
            padding: 6px 20px;
            display: flex;
            justify-content: center;
            gap: 25px;
            position: sticky;
            top: 0;
            z-index: 99999;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .top-nav a {
            color: #94a3b8;
            text-decoration: none;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            padding: 4px 0;
        }

        .top-nav a:hover {
            color: #ffffff;
            transform: translateY(-1px);
        }

        .top-nav a.active {
            color: #818cf8;
            border-bottom: 2px solid #818cf8;
        }
    </style>
</head>

<body style="padding: 0;">
    <nav class="top-nav">
        <a href="index.html">üè† Inicio</a>
        <a href="AnalisisProduccion.html">üìà Producci√≥n</a>
        <a href="AnalisisSegmentos.html" class="active">üë• Segmentos</a>
        <a href="AnalisisCompetencia.html">‚öñÔ∏è Competencia</a>
        <a href="CalculadoraPresupuesto.html">üí∞ Presupuesto</a>
        <a href="CargarDatos.html">‚öôÔ∏è Config</a>
    </nav>
    <div class="container" style="padding: 15px;">
        <header class="header">
            <div style="display: flex; align-items: center; gap: 20px;">
                <a href="index.html" title="Inicio"><img src="Imagen/logo, CapaSuite.png" alt="CapaSuite"
                        style="height: 50px;"></a>
                <img id="hotelLogo" src="Imagen/logo-guadiana.svg" alt="Logo Hotel" style="height: 45px;">
                <div class="title">
                    <h1>Producci√≥n por Segmentos</h1>
                    <p>An√°lisis de canales y tipos de cliente</p>
                </div>
            </div>
            <div style="display:flex; gap:12px; align-items:center;">
                <select id="yearSelector" class="form-select" onchange="updateView()"
                    style="padding:10px; border-radius:8px; border:1px solid #e2e8f0;"></select>
                <select id="monthSelector" class="form-select" onchange="updateView()"
                    style="padding:10px; border-radius:8px; border:1px solid #e2e8f0;"></select>
                <select id="metricSelector" class="form-select" onchange="updateView()"
                    style="padding:10px; border-radius:8px; border:1px solid #e2e8f0; font-weight:600; color:var(--primary);">
                    <option value="revenue" selected>üí∂ Producci√≥n (‚Ç¨)</option>
                    <option value="rooms">üõèÔ∏è Habitaciones (RN)</option>
                    <option value="adr">üè∑Ô∏è ADR (‚Ç¨/hab)</option>
                </select>
                <select id="hotelSelector" class="form-select" onchange="switchHotel(this.value)"
                    style="padding:10px; border-radius:8px; border:1px solid #e2e8f0; font-weight:600;">
                    <option value="Guadiana">Hotel Guadiana</option>
                    <option value="Cumbria">Hotel Cumbria</option>
                </select>
                <button class="btn" onclick="document.getElementById('fileInput').click()">üìÇ A√±adir</button>
            </div>
        </header>

        <div id="upload-section" class="upload-area" onclick="document.getElementById('fileInput').click()">
            <div style="font-size: 3rem; margin-bottom: 15px;">üë•</div>
            <h2>Importar Datos de Segmentaci√≥n</h2>
            <p>Selecciona archivos Excel de segmentaci√≥n mensual o anual</p>
            <input type="file" id="fileInput" multiple accept=".xlsx,.xls" hidden onchange="handleFiles(this.files)">
        </div>

        <div id="loader" class="loader"></div>

        <div id="dashboard" class="dashboard">
            <div class="kpi-grid">
                <div class="card" style="border-left: 4px solid var(--primary);">
                    <div class="kpi-label">Producci√≥n Total</div>
                    <div class="kpi-value" id="kpi-prod">0 ‚Ç¨</div>
                    <div id="kpi-prod-diff" class="kpi-diff">‚Äî</div>
                </div>
                <div class="card">
                    <div class="kpi-label">Habitaciones (RN)</div>
                    <div class="kpi-value" id="kpi-rooms">0</div>
                    <div id="kpi-rooms-diff" class="kpi-diff">‚Äî</div>
                </div>
                <div class="card">
                    <div class="kpi-label">ADR Medio</div>
                    <div class="kpi-value" id="kpi-adr">0 ‚Ç¨</div>
                    <div id="kpi-adr-diff" class="kpi-diff">‚Äî</div>
                </div>
                <div class="card">
                    <div class="kpi-label">RevPAR</div>
                    <div class="kpi-value" id="kpi-revpar">0 ‚Ç¨</div>
                    <div id="kpi-revpar-diff" class="kpi-diff">‚Äî</div>
                </div>
            </div>

            <div class="metric-indicator">
                <span class="metric-icon" id="metric-icon">üí∂</span>
                <span class="metric-name" id="metric-name">PRODUCCI√ìN (‚Ç¨)</span>
                <span class="metric-years" id="metric-years">2026 vs 2025</span>
            </div>

            <div class="charts-row">
                <div class="card">
                    <div class="kpi-label">Evoluci√≥n Mensual</div>
                    <div class="chart-container"><canvas id="mainChart"></canvas></div>
                </div>
                <div class="card">
                    <div class="kpi-label">Comparativa Anual</div>
                    <div class="chart-container"><canvas id="topChart"></canvas></div>
                </div>
                <div class="card">
                    <div class="kpi-label">Distribuci√≥n Segmentos</div>
                    <div class="chart-container"><canvas id="distChart"></canvas></div>
                </div>
            </div>

            <div class="card" style="padding: 0;">
                <div style="padding: 20px; border-bottom: 1px solid var(--border);">
                    <h3 id="table-title">Detalle por Segmento</h3>
                </div>
                <div class="table-container">
                    <table id="dataTable">
                        <thead id="tableHead"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <script>
        // Repost of core logic from AnalisisProduccion.html but locked to segments
        const MONTH_ORDER = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const SHORT_MONTHS = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
        const HOTELS = { "Guadiana": { name: "Hotel Guadiana", rooms: 80 }, "Cumbria": { name: "Hotel Cumbria", rooms: 120 } };

        let db = {};
        let currentHotel = "Guadiana";
        let currentYear = "";
        let currentMonthFilter = "All";
        let currentMetric = "revenue";
        const STORAGE_KEY = "hotel_manager_db_v2";
        let charts = {};

        window.onload = function () { loadData(); document.getElementById('hotelSelector').value = currentHotel; };

        function switchHotel(h) {
            currentHotel = h;
            document.getElementById('hotelLogo').src = h === 'Guadiana' ? 'Imagen/logo-guadiana.svg' : 'Imagen/logo-cumbria.svg';
            refreshAvailableYears();
            if (currentYear) {
                initControls();
                document.getElementById('dashboard').style.display = 'flex';
                document.getElementById('upload-section').style.display = 'none';
            } else {
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('upload-section').style.display = 'block';
                const ys = document.getElementById('yearSelector');
                if (ys) ys.innerHTML = '';
            }
        }

        function loadData() {
            const s = CapaStorage.getItem(STORAGE_KEY);
            if (s) {
                try {
                    db = JSON.parse(s);
                    if (typeof db !== 'object' || db === null) db = {};
                } catch (e) {
                    console.error("Error parsing DB", e);
                    db = {};
                }
                refreshAvailableYears();
                if (currentYear) {
                    initControls();
                    document.getElementById('dashboard').style.display = 'flex';
                    document.getElementById('upload-section').style.display = 'none';
                    return;
                }
            }
            document.getElementById('upload-section').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
        }

        function refreshAvailableYears() {
            const y = (db[currentHotel] && typeof db[currentHotel] === 'object') ? Object.keys(db[currentHotel]) : [];
            if (y.length) {
                currentYear = y.sort().reverse()[0];
            } else {
                currentYear = "";
            }
        }

        function saveData() { CapaStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }

        async function handleFiles(files) {
            document.getElementById('loader').style.display = 'block';
            document.getElementById('upload-section').style.display = 'none';
            if (!db[currentHotel]) db[currentHotel] = {};

            for (let f of files) {
                const buf = await f.arrayBuffer();
                const wb = XLSX.read(buf, { type: 'array' });
                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });

                // Use the complex processing logic from the original file
                processData(data, f.name);
            }
            saveData(); refreshAvailableYears(); initControls();
            document.getElementById('loader').style.display = 'none';
            document.getElementById('dashboard').style.display = 'flex';
        }

        function processData(data, fileName) {
            // 1. Detect Year
            let detectedYear = "2026";
            let headerRow = null;
            // Scan first 10 rows for month headers
            for (let r = 0; r < 10; r++) {
                const row = data[r] || [];
                if (row.some(c => {
                    const s = String(c).toUpperCase();
                    return s.includes("ENE") || s.includes("JAN") || s.includes("TOTAL");
                })) {
                    headerRow = row;
                    break;
                }
            }

            if (headerRow) {
                for (let c = 0; c < headerRow.length; c++) {
                    const h = String(headerRow[c]);
                    const yrMatch = h.match(/[.\-\/ ](\d{2,4})$/);
                    if (yrMatch) {
                        detectedYear = yrMatch[1].length === 2 ? "20" + yrMatch[1] : yrMatch[1];
                        break;
                    }
                }
            }

            if (!db[currentHotel][detectedYear]) db[currentHotel][detectedYear] = { segment: {}, service: {}, lastUpdate: "" };
            const dbYear = db[currentHotel][detectedYear];

            // Clear existing segments for this specific year
            dbYear.segment = {};

            let currentSeg = null;
            let filledHab = false;
            let filledPro = false;

            // 2. Iterate through rows
            for (let r = 0; r < data.length; r++) {
                let row = data[r];
                if (!row || row.length < 2) continue;

                let col0 = String(row[0] || "").trim();
                let col1 = String(row[1] || "").trim().toUpperCase();

                const isHab = col1.includes("HAB") || col1.includes("RMS");
                const isPro = col1.includes("PRO") || col1.includes("REV") || col1.includes("ING");

                if (col0) {
                    const col0Upper = col0.toUpperCase();
                    if (col0Upper === "XXXX" || col0Upper === "SEG." || col0Upper === "S/S") {
                        currentSeg = "S/S";
                    } else if (col0Upper.includes("TOTAL")) {
                        currentSeg = "TOTAL";
                    } else {
                        currentSeg = col0;
                    }
                    filledHab = false;
                    filledPro = false;
                } else if (!col0 && (isHab || isPro)) {
                    // Deteci√≥n de TOTAL
                    if ((isHab && filledHab) || (isPro && filledPro)) {
                        currentSeg = "TOTAL";
                    }
                }

                if (!currentSeg) continue;

                if (isHab || isPro) {
                    if (!dbYear.segment[currentSeg]) {
                        dbYear.segment[currentSeg] = {
                            name: currentSeg,
                            revenue: new Array(12).fill(0),
                            rooms: new Array(12).fill(0)
                        };
                    }
                    const segObj = dbYear.segment[currentSeg];

                    // 3. Map columns C+ to months (0-11)
                    for (let c = 2; c < row.length; c++) {
                        const midx = c - 2;
                        if (midx > 11) break;

                        let val = parseVal(row[c]);
                        if (isHab) {
                            segObj.rooms[midx] = val;
                            filledHab = true;
                        } else if (isPro) {
                            segObj.revenue[midx] = val;
                            filledPro = true;
                        }
                    }
                }
            }

            dbYear.lastUpdate = new Date().toLocaleDateString('es-ES');
        }

        function parseVal(val) {
            if (val === null || val === undefined || val === "") return 0;
            if (typeof val === 'number') return val;
            let s = String(val).replace(/[‚Ç¨$\s\u00a0]/g, "").trim();
            const lastComma = s.lastIndexOf(',');
            const lastDot = s.lastIndexOf('.');
            if (lastComma > lastDot) s = s.replace(/\./g, "").replace(",", ".");
            else if (lastDot > lastComma && lastComma !== -1) s = s.replace(/,/g, "");
            else if (lastComma !== -1) s = s.replace(",", ".");
            const num = parseFloat(s);
            return isNaN(num) ? 0 : num;
        }

        function initControls() {
            const ys = document.getElementById('yearSelector');
            const years = db[currentHotel] ? Object.keys(db[currentHotel]) : ["2026"];
            ys.innerHTML = years.sort().reverse().map(y => `<option value="${y}">${y}</option>`).join('');
            ys.value = currentYear;

            const ms = document.getElementById('monthSelector');
            ms.innerHTML = '<option value="All">Todos los meses</option>' + MONTH_ORDER.map((m, i) => `<option value="${i}">${m}</option>`).join('');
            updateView();
        }

        function updateView() {
            currentYear = document.getElementById('yearSelector').value;
            currentMonthFilter = document.getElementById('monthSelector').value;
            currentMetric = document.getElementById('metricSelector').value;

            const info = { revenue: { icon: 'üí∂', name: 'PRODUCCI√ìN (‚Ç¨)' }, rooms: { icon: 'üõèÔ∏è', name: 'HABITACIONES (RN)' }, adr: { icon: 'üè∑Ô∏è', name: 'ADR (‚Ç¨/hab)' } }[currentMetric];
            document.getElementById('metric-icon').innerText = info.icon;
            document.getElementById('metric-name').innerText = info.name;
            document.getElementById('metric-years').innerText = `${currentYear} vs ${(currentYear - 1)}`;

            renderDashboard();
        }

        function renderDashboard() {
            const data = db[currentHotel][currentYear]; if (!data) return;
            const dataPrev = db[currentHotel][currentYear - 1];
            const concepts = Object.values(data.segment);

            const mTotals = new Array(12).fill(0);
            const mRooms = new Array(12).fill(0);
            concepts.forEach(c => {
                for (let i = 0; i < 12; i++) {
                    mTotals[i] += c.revenue[i];
                    mRooms[i] += c.rooms[i];
                }
            });

            const mTotalsPrev = new Array(12).fill(0);
            const mRoomsPrev = new Array(12).fill(0);
            if (dataPrev) {
                Object.values(dataPrev.segment).forEach(c => {
                    for (let i = 0; i < 12; i++) {
                        mTotalsPrev[i] += c.revenue[i];
                        mRoomsPrev[i] += c.rooms[i];
                    }
                });
            }

            const midx = currentMonthFilter === "All" ? -1 : parseInt(currentMonthFilter);

            // Prioritize the explicit "TOTAL" object from Excel if it exists
            const totalObj = data.segment["TOTAL"];
            let totalRev, totalRN;

            if (totalObj) {
                totalRev = midx === -1 ? totalObj.revenue.reduce((a, b) => a + b, 0) : totalObj.revenue[midx];
                totalRN = midx === -1 ? totalObj.rooms.reduce((a, b) => a + b, 0) : totalObj.rooms[midx];
            } else {
                totalRev = midx === -1 ? mTotals.reduce((a, b) => a + b, 0) : mTotals[midx];
                totalRN = midx === -1 ? mRooms.reduce((a, b) => a + b, 0) : mRooms[midx];
            }

            // LY Data for Trends
            let totalRevPrev = 0, totalRNPrev = 0;
            if (dataPrev) {
                const totalObjPrev = dataPrev.segment["TOTAL"];
                if (totalObjPrev) {
                    totalRevPrev = midx === -1 ? totalObjPrev.revenue.reduce((a, b) => a + b, 0) : totalObjPrev.revenue[midx];
                    totalRNPrev = midx === -1 ? totalObjPrev.rooms.reduce((a, b) => a + b, 0) : totalObjPrev.rooms[midx];
                } else {
                    totalRevPrev = midx === -1 ? mTotalsPrev.reduce((a, b) => a + b, 0) : mTotalsPrev[midx];
                    totalRNPrev = midx === -1 ? mRoomsPrev.reduce((a, b) => a + b, 0) : mRoomsPrev[midx];
                }
            }

            const fmt = (n) => {
                if (n === 0 || n === null || n === undefined) return "0 ‚Ç¨";
                return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + " ‚Ç¨";
            };
            const fmtNum = (n) => {
                if (n === 0 || n === null || n === undefined) return "0";
                return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            };
            const fmtVal = (n) => currentMetric === 'revenue' ? fmt(n) : (currentMetric === 'adr' ? n.toFixed(2).replace('.', ',') + " ‚Ç¨" : fmtNum(n));

            document.getElementById('kpi-prod').innerText = fmt(totalRev);
            document.getElementById('kpi-rooms').innerText = fmtNum(totalRN);
            const adr = totalRN > 0 ? (totalRev / totalRN) : 0;
            document.getElementById('kpi-adr').innerText = adr.toFixed(2).replace('.', ',') + " ‚Ç¨";

            // Trends
            const setTrend = (id, cur, prev) => {
                const el = document.getElementById(id);
                if (!prev) { el.innerText = "‚Äî"; return; }
                const diff = ((cur - prev) / prev * 100).toFixed(1);
                const isPos = parseFloat(diff) >= 0;
                el.innerHTML = `<span style="color:${isPos ? 'var(--success)' : '#ef4444'}">${isPos ? '‚ñ≤' : '‚ñº'} ${Math.abs(diff)}%</span> vs LY`;
            };
            setTrend('kpi-prod-diff', totalRev, totalRevPrev);
            setTrend('kpi-rooms-diff', totalRN, totalRNPrev);
            const adrPrev = totalRNPrev > 0 ? (totalRevPrev / totalRNPrev) : 0;
            setTrend('kpi-adr-diff', adr, adrPrev);

            // RevPAR
            const hotelRooms = HOTELS[currentHotel].rooms;
            const daysInPeriod = midx === -1 ? 365 : 30;
            const revpar = totalRev / (hotelRooms * daysInPeriod);
            const revparPrev = totalRevPrev / (hotelRooms * daysInPeriod);
            document.getElementById('kpi-revpar').innerText = revpar.toFixed(2).replace('.', ',') + " ‚Ç¨";
            setTrend('kpi-revpar-diff', revpar, revparPrev);

            // Table
            const tbody = document.getElementById('tableBody');
            const thead = document.getElementById('tableHead');
            let body = '';

            // Filter out empty segments and handle TOTAL uniquely
            const activeConcepts = concepts.filter(c => c.revenue.some(v => v > 0) || c.rooms.some(v => v > 0));

            if (midx === -1) {
                thead.innerHTML = '<tr><th>Segmento</th>' + SHORT_MONTHS.map(m => `<th>${m}</th>`).join('') + '<th>Total</th><th>% Mix</th></tr>';
                activeConcepts.sort((a, b) => b.revenue.reduce((x, y) => x + y, 0) - a.revenue.reduce((x, y) => x + y, 0)).forEach(c => {
                    if (c.name === "TOTAL") return; // We handle total specially or skip if it's already in the header/KPIs
                    const rowRev = c.revenue.reduce((a, b) => a + b, 0);
                    const rowRooms = c.rooms.reduce((a, b) => a + b, 0);
                    const valTotal = currentMetric === 'revenue' ? rowRev : (currentMetric === 'rooms' ? rowRooms : (rowRooms > 0 ? rowRev / rowRooms : 0));

                    const cells = c.revenue.map((v, idx) => {
                        const vCell = currentMetric === 'revenue' ? v : (currentMetric === 'rooms' ? c.rooms[idx] : (c.rooms[idx] > 0 ? v / c.rooms[idx] : 0));
                        return `<td>${vCell ? fmtVal(vCell) : '-'}</td>`;
                    }).join('');

                    body += `<tr><td style="font-weight:600;">${c.name}</td>${cells}<td style="font-weight:700;">${fmtVal(valTotal)}</td><td>${(rowRev / totalRev * 100).toFixed(1)}%</td></tr>`;
                });
            } else {
                thead.innerHTML = '<tr><th>Segmento</th><th>Valor Detalle</th><th>% Mix Total</th></tr>';
                activeConcepts.sort((a, b) => b.revenue[midx] - a.revenue[midx]).forEach(c => {
                    if (c.name === "TOTAL") return;
                    const rev = c.revenue[midx];
                    const rooms = c.rooms[midx];
                    const val = currentMetric === 'revenue' ? rev : (currentMetric === 'rooms' ? rooms : (rooms > 0 ? rev / rooms : 0));
                    body += `<tr><td style="font-weight:600;">${c.name}</td><td>${fmtVal(val)}</td><td>${(rev / totalRev * 100).toFixed(1)}%</td></tr>`;
                });
            }
            tbody.innerHTML = body;

            updateCharts(mTotals, mRooms, mTotalsPrev, mRoomsPrev, concepts, midx);
        }

        function updateCharts(mTotals, mRooms, mTotalsPrev, mRoomsPrev, concepts, midx) {
            const isRooms = currentMetric === 'rooms';
            const isAdr = currentMetric === 'adr';

            const getMetricData = (revArr, rmsArr) => {
                if (isRooms) return rmsArr;
                if (isAdr) return revArr.map((v, i) => rmsArr[i] > 0 ? (v / rmsArr[i]).toFixed(1) : 0);
                return revArr;
            };

            const mainData = getMetricData(mTotals, mRooms);
            const prevData = getMetricData(mTotalsPrev, mRoomsPrev);

            if (charts.main) charts.main.destroy();
            charts.main = new Chart(document.getElementById('mainChart'), {
                type: 'line',
                data: {
                    labels: SHORT_MONTHS,
                    datasets: [
                        { label: currentYear, data: mainData, borderColor: '#4f46e5', fill: true, backgroundColor: 'rgba(79,70,229,0.1)', tension: 0.4 },
                        { label: (currentYear - 1), data: prevData, borderColor: '#94a3b8', borderDash: [5, 5], fill: false, tension: 0.4 }
                    ]
                },
                options: { maintainAspectRatio: false }
            });

            // Comparativa Anual Bar Chart
            if (charts.top) charts.top.destroy();
            const yearSum = mainData.reduce((a, b) => parseFloat(a) + parseFloat(b), 0);
            const prevSum = prevData.reduce((a, b) => parseFloat(a) + parseFloat(b), 0);

            charts.top = new Chart(document.getElementById('topChart'), {
                type: 'bar',
                data: {
                    labels: [currentYear, (currentYear - 1)],
                    datasets: [{
                        data: [yearSum, prevSum],
                        backgroundColor: ['#4f46e5', '#94a3b8']
                    }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            if (charts.dist) charts.dist.destroy();
            const dLabels = [], dData = [];
            concepts.forEach(c => {
                if (c.name === "TOTAL") return;
                let v = 0;
                if (midx === -1) {
                    const r = c.revenue.reduce((a, b) => a + b, 0);
                    const rms = c.rooms.reduce((a, b) => a + b, 0);
                    v = isRooms ? rms : (isAdr ? (rms > 0 ? r / rms : 0) : r);
                } else {
                    v = isRooms ? c.rooms[midx] : (isAdr ? (c.rooms[midx] > 0 ? c.revenue[midx] / c.rooms[midx] : 0) : c.revenue[midx]);
                }
                if (v > 0) { dLabels.push(c.name); dData.push(v); }
            });
            charts.dist = new Chart(document.getElementById('distChart'), {
                type: 'doughnut', data: { labels: dLabels, datasets: [{ data: dData, backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#475569', '#94a3b8'] }] },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });
        }
    </script>
</body>

</html>