<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis de Servicios | CapaSuite</title>
    <link rel="icon" type="image/png" href="Imagen/Icono_CapaSuite.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="js/xlsx.full.min.js"></script>
    <script src="js/chart.js"></script>
    <script src="js/storage.js"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #3730a3;
            --bg-body: #f8fafc;
            --bg-surface: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --radius: 12px;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            font-size: 13px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: var(--bg-surface);
            padding: 20px 30px;
            border-radius: var(--radius);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .title h1 {
            font-size: 1.5rem;
            margin: 0;
            color: var(--primary-dark);
        }

        .card {
            background: var(--bg-surface);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 24px;
        }

        .kpi-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .kpi-value {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .charts-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .chart-card {
            display: flex;
            flex-direction: column;
            height: 350px;
        }

        .chart-container {
            flex: 1;
            position: relative;
            min-height: 0;
        }

        .table-container {
            overflow: auto;
            max-height: 600px;
            border-radius: var(--radius);
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap;
        }

        th,
        td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            text-align: right;
            font-size: 0.85rem;
        }

        th {
            background: #f1f5f9;
            color: var(--text-muted);
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.7rem;
            text-transform: uppercase;
        }

        th:first-child,
        td:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: inherit;
            z-index: 11;
            font-weight: 500;
        }

        .row-group {
            background: #f8fafc;
            font-weight: 700;
            color: var(--primary);
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .upload-area {
            background: var(--bg-surface);
            border: 2px dashed #cbd5e1;
            border-radius: 16px;
            padding: 60px;
            text-align: center;
            cursor: pointer;
        }

        .loader {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="header">
            <div style="display: flex; align-items: center; gap: 20px;">
                <a href="index.html"><img src="Imagen/logo, CapaSuite.png" alt="CapaSuite" style="height: 50px;"></a>
                <img id="hotelLogo" src="Imagen/logo-guadiana.svg" alt="Logo Hotel" style="height: 45px;">
                <div class="title">
                    <h1>Producci√≥n Detallada</h1>
                    <p>Agrupaci√≥n seg√∫n Modelo Final</p>
                </div>
            </div>
            <div style="display:flex; gap:12px; align-items:center;">
                <select id="yearSelector" onchange="updateView()"
                    style="padding:10px; border-radius:8px; border:1px solid #e2e8f0;"></select>
                <select id="monthSelector" onchange="updateView()"
                    style="padding:10px; border-radius:8px; border:1px solid #e2e8f0;"></select>
                <select id="hotelSelector" onchange="switchHotel(this.value)"
                    style="padding:10px; border-radius:8px; border:1px solid #e2e8f0; font-weight:600;">
                    <option value="Guadiana">Hotel Guadiana</option>
                    <option value="Cumbria">Hotel Cumbria</option>
                </select>
            </div>
        </header>

        <div id="no-data-section" class="upload-area" style="display:none;">
            <div style="font-size: 3rem; margin-bottom: 20px;">üìä</div>
            <h2>No se han encontrado datos</h2>
            <p>Por favor, utiliza el m√≥dulo de <b>Carga de Datos</b> para importar tus informes.</p>
            <a href="CargarDatos.html" class="btn"
                style="display:inline-block; text-decoration:none; margin-top:20px;">Ir a Carga de Datos</a>
        </div>

        <div id="loader" class="loader"></div>

        <div id="dashboard" style="display:none; flex-direction:column; gap:24px;">
            <div class="kpi-grid">
                <div class="card" style="border-left: 4px solid var(--primary);">
                    <div class="kpi-label">Total Producci√≥n</div>
                    <div class="kpi-value" id="kpi-total">0 ‚Ç¨</div>
                </div>
                <div class="card">
                    <div class="kpi-label">Room Nights (Ocupadas)</div>
                    <div class="kpi-value" id="kpi-rn">0</div>
                </div>
                <div class="card">
                    <div class="kpi-label">Pax (Personas)</div>
                    <div class="kpi-value" id="kpi-pax">0</div>
                </div>
                <div class="card" style="background: #f0fdf4;">
                    <div class="kpi-label" style="color: #166534;">ADR (Precio Medio)</div>
                    <div class="kpi-value" id="kpi-adr" style="color: #166534;">0 ‚Ç¨</div>
                </div>
                <div class="card" style="background: #eff6ff;">
                    <div class="kpi-label" style="color: #1e40af;">RevPAC (Gasto Medio)</div>
                    <div class="kpi-value" id="kpi-revpac" style="color: #1e40af;">0 ‚Ç¨</div>
                </div>
            </div>

            <div class="charts-row">
                <div class="card chart-card">
                    <div class="kpi-label">Evoluci√≥n Ingresos Mensuales</div>
                    <div class="chart-container"><canvas id="mainChart"></canvas></div>
                </div>
                <div class="card chart-card">
                    <div class="kpi-label">Mix de Producci√≥n</div>
                    <div class="chart-container"><canvas id="distChart"></canvas></div>
                </div>
            </div>

            <div class="card" style="padding: 0;">
                <div style="padding: 20px; border-bottom: 1px solid var(--border);">
                    <h3>Auditor√≠a de Conceptos por Categor√≠a</h3>
                </div>
                <div class="table-container">
                    <table id="dataTable">
                        <thead id="tableHead"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const MONTH_ORDER = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const SHORT_MONTHS = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];

        const PRODUCTION_GROUPS = {
            "HABITACION": { name: "1. Habitaci√≥n", keys: ["HABITACI√ìN", "HABITACION", "ALOJAMIENTO", "ESTANCIA", "DUI", "DOBLE", "SUPERIOR", "SUITE", "CUADRUPLE", "TRIPLE", "FAMILIAR", "LATE CHECK OUT", "AMPLIACION", "CAMA SUPLETORIA"] },
            "DESAYUNOS": { name: "2. Desayunos", keys: ["DESAYUNO BUFFET", "DESAYUNO GRUPO", "DESAYUNO", "BUFFET"] },
            "RESTAURANTE": { name: "3. Restaurante", keys: ["RESTAURANTE", "CENA", "ALMUERZO", "CENA GRUPO", "ALMUERZO GRUPO", "CATERING"] },
            "EVENTOS": { name: "4. Eventos", keys: ["COFFEE BREAK", "SALONES/ALQUILER", "AUDIOVISUALES", "SALON", "ALQUILER", "EVENTO", "OFICINA", "RETENCIONES"] },
            "CAFETERIA": { name: "5. Cafeter√≠a", keys: ["CAFETER√çA/HAB", "CAFETERIA", "BAR"] },
            "MINIBAR": { name: "6. Minibar", keys: ["MINIBAR"] },
            "SPA": { name: "7. Spa", keys: ["SPA", "BALNEARIO", "MASAJE", "TRATAMIENTO"] },
            "PARKING": { name: "8. Parking", keys: ["GARAJE", "PARKING"] },
            "SUPLEMENTOS": { name: "9. Suplementos", keys: ["SUPLEMENTO", "MASCOTA", "CUNA", "UPGRADE"] },
            "VARIOS": { name: "10. Varios", keys: ["LAVANDER√çA", "ARTESAN√çA", "FAX", "TEL√âFONO", "VARIOS", "LAVANDERIA", "ARTESANIA", "TELEFONO"] }
        };

        const IGNORE_LIST = ["PRODUCCION TOTAL", "MXH", "PRODUCCION HABITACION", "PRO", "HAB", "PAX", "PERSONAS"];

        let db = {};
        let currentHotel = "Guadiana";
        let currentYear = "";
        const STORAGE_KEY = "hotel_manager_db_v2";
        let charts = {};

        window.onload = function () { loadData(); document.getElementById('hotelSelector').value = currentHotel; };

        function loadData() {
            const s = CapaStorage.getItem(STORAGE_KEY);
            if (s) {
                try {
                    db = JSON.parse(s);
                    if (typeof db !== 'object' || db === null) db = {};
                } catch (e) {
                    console.error("Error parsing DB", e);
                    db = {};
                }
                refreshYears();
                if (currentYear) {
                    initControls();
                    document.getElementById('dashboard').style.display = 'flex';
                    document.getElementById('no-data-section').style.display = 'none';
                    return;
                }
            }
            // Si llegamos aqu√≠, no hay datos v√°lidos o no hay a√±os
            document.getElementById('no-data-section').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
        }

        function refreshYears() {
            const y = (db[currentHotel] && typeof db[currentHotel] === 'object') ? Object.keys(db[currentHotel]) : [];
            if (y.length) {
                currentYear = y.sort().reverse()[0];
            } else {
                currentYear = "";
            }
        }

        function switchHotel(h) {
            currentHotel = h;
            document.getElementById('hotelLogo').src = h === 'Guadiana' ? 'Imagen/logo-guadiana.svg' : 'Imagen/logo-cumbria.svg';
            refreshYears();
            if (currentYear) {
                initControls();
                document.getElementById('dashboard').style.display = 'flex';
                document.getElementById('no-data-section').style.display = 'none';
            } else {
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('no-data-section').style.display = 'block';
                // Reset year selector if exists
                const ys = document.getElementById('yearSelector');
                if (ys) ys.innerHTML = '';
            }
        }



        function initControls() {
            const ys = document.getElementById('yearSelector'); ys.innerHTML = Object.keys(db[currentHotel] || { "2026": {} }).sort().reverse().map(y => `<option value="${y}">${y}</option>`).join(''); ys.value = currentYear;
            const ms = document.getElementById('monthSelector'); ms.innerHTML = '<option value="All">Todos los meses</option>' + MONTH_ORDER.map((m, i) => `<option value="${i}">${m}</option>`).join('');
            updateView();
        }

        function updateView() { currentYear = document.getElementById('yearSelector').value; render(); }

        function normalizeStr(str) { return String(str || "").toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim(); }

        function getGroupID(name) {
            const norm = normalizeStr(name);
            // Omitir ratios t√©cnicos y subtotales duplicados
            if (norm === "HAB" || norm === "PAX" || norm === "PRO" || norm === "MXH" ||
                norm.includes("TOTAL") || norm.includes("PRODUCCION") || norm === "PERSONAS") return "OMIT";

            const eventKeywords = ["GRUPO", "CATERING", "COFFEE", "SALA", "SALON", "EVENTO", "ALQUILER", "AUDIOVISUAL"];

            for (const [id, g] of Object.entries(PRODUCTION_GROUPS)) {
                if (id === "RESTAURANTE" && eventKeywords.some(k => norm.includes(k))) continue;
                if (g.keys.some(k => norm.includes(normalizeStr(k)))) return id;
            }
            return "VARIOS";
        }

        function render() {
            if (!db[currentHotel] || !db[currentHotel][currentYear]) {
                document.getElementById('dashboard').style.display = 'none';
                document.getElementById('no-data-section').style.display = 'block';
                return;
            }
            const data = db[currentHotel][currentYear];
            const midx = document.getElementById('monthSelector').value === "All" ? -1 : parseInt(document.getElementById('monthSelector').value);

            // Aligned with TOTAL_MASTER for expert KPIs
            const master = data.service["TOTAL_MASTER"] || { revenue: new Array(12).fill(0), rooms: new Array(12).fill(0), pax: new Array(12).fill(0) };

            const getValFromArr = (arr) => midx === -1 ? arr.reduce((a, b) => a + b, 0) : arr[midx];

            const tRev = getValFromArr(master.revenue);
            const tRn = getValFromArr(master.rooms);
            const tPax = getValFromArr(master.pax);

            const groupedData = {};
            Object.keys(PRODUCTION_GROUPS).forEach(id => { groupedData[id] = { name: PRODUCTION_GROUPS[id].name, revenue: new Array(12).fill(0), details: [] }; });

            Object.values(data.service).forEach(s => {
                if (s.name === "TOTAL_MASTER" || s.name === "TOTAL_REAL") return;
                const gid = getGroupID(s.name);
                if (gid === "OMIT" || !groupedData[gid]) return;
                for (let i = 0; i < 12; i++) {
                    if (s.revenue && s.revenue[i] !== undefined) {
                        groupedData[gid].revenue[i] += s.revenue[i];
                    }
                }
                groupedData[gid].details.push(s);
            });

            const fmt = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(n);
            const fmtN = (n) => new Intl.NumberFormat('es-ES', { maximumFractionDigits: 0 }).format(n);

            document.getElementById('kpi-total').innerText = fmt(tRev);
            document.getElementById('kpi-rn').innerText = fmtN(tRn);
            document.getElementById('kpi-pax').innerText = fmtN(tPax);
            document.getElementById('kpi-adr').innerText = tRn > 0 ? fmt(tRev / tRn) : "0 ‚Ç¨";
            document.getElementById('kpi-revpac').innerText = tPax > 0 ? fmt(tRev / tPax) : "0 ‚Ç¨";

            // Table
            const thead = document.getElementById('tableHead'); thead.innerHTML = midx === -1 ? '<tr><th>Categor√≠a / Concepto</th>' + SHORT_MONTHS.map(m => `<th>${m}</th>`).join('') + '<th>Total</th></tr>' : '<tr><th>Categor√≠a / Concepto</th><th>Valor</th><th>% Mix</th></tr>';
            const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';

            Object.values(groupedData).sort((a, b) => {
                const nA = parseInt(a.name.split('.')[0]);
                const nB = parseInt(b.name.split('.')[0]);
                return nA - nB;
            }).forEach(g => {
                const gTotal = getValFromArr(g.revenue); if (gTotal === 0 && g.details.length === 0) return;

                let row = `<tr class="row-group"><td>${g.name}</td>`;
                if (midx === -1) {
                    row += g.revenue.map(v => `<td>${v ? new Intl.NumberFormat('es-ES').format(v) : '-'}</td>`).join('') + `<td>${fmt(gTotal)}</td>`;
                } else {
                    row += `<td>${fmt(gTotal)}</td><td>${tRev > 0 ? (gTotal / tRev * 100).toFixed(1) : 0}%</td>`;
                }
                tbody.innerHTML += row + '</tr>';

                g.details.sort((a, b) => getValFromArr(b.revenue) - getValFromArr(a.revenue)).forEach(s => {
                    const sVal = getValFromArr(s.revenue); if (sVal === 0) return;
                    let sRow = `<tr><td style="padding-left:15px; font-size: 0.8rem; color: #475569;">${s.name}</td>`;
                    if (midx === -1) {
                        sRow += s.revenue.map(v => `<td>${v ? new Intl.NumberFormat('es-ES').format(v) : '-'}</td>`).join('') + `<td>${new Intl.NumberFormat('es-ES', { maximumFractionDigits: 0 }).format(sVal)} ‚Ç¨</td>`;
                    } else {
                        sRow += `<td>${new Intl.NumberFormat('es-ES', { maximumFractionDigits: 0 }).format(sVal)} ‚Ç¨</td><td>${tRev > 0 ? (sVal / tRev * 100).toFixed(1) : 0}%</td>`;
                    }
                    tbody.innerHTML += sRow + '</tr>';
                });
            });

            if (charts.main) charts.main.destroy();
            charts.main = new Chart(document.getElementById('mainChart'), { type: 'line', data: { labels: SHORT_MONTHS, datasets: [{ label: currentYear, data: master.revenue, borderColor: '#4f46e5', tension: 0.4 }] }, options: { maintainAspectRatio: false } });

            if (charts.dist) charts.dist.destroy();
            const dLabels = [], dData = [];
            Object.values(groupedData).forEach(g => { const v = getValFromArr(g.revenue); if (v > 0) { dLabels.push(g.name.split('. ')[1]); dData.push(v); } });
            charts.dist = new Chart(document.getElementById('distChart'), { type: 'doughnut', data: { labels: dLabels, datasets: [{ data: dData, backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899', '#84cc16', '#64748b', '#1e293b'] }] }, options: { maintainAspectRatio: false, plugins: { legend: { position: 'right' } } } });
        }
    </script>
</body>

</html>