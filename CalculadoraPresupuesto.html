<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presupuestos 2026 | CapaSuite</title>
    <link rel="icon" type="image/png" href="Imagen/Icono_CapaSuite.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Chart.js -->
    <script src="js/chart.js"></script>

    <style>
        :root {
            /* Palette - Modern & Premium */
            --primary: #4f46e5;
            /* Indigo 600 */
            --primary-dark: #4338ca;
            /* Indigo 700 */
            --secondary: #64748b;
            /* Slate 500 */
            --bg-body: #f8fafc;
            /* Slate 50 */
            --bg-card: #ffffff;
            --text-main: #1e293b;
            /* Slate 800 */
            --text-muted: #64748b;
            --success: #10b981;
            /* Emerald 500 */
            --danger: #ef4444;
            /* Red 500 */
            --warning: #f59e0b;
            /* Amber 500 */
            --border: #e2e8f0;
            /* Slate 200 */

            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

            --font-main: 'Inter', sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            font-size: 14px;
            line-height: 1.5;
        }

        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* HEADER */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
            padding: 20px 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .header-title h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .header-title p {
            margin: 4px 0 0;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .strategy-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .select-wrapper {
            position: relative;
        }

        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-family: var(--font-main);
            font-size: 0.9rem;
            color: var(--text-main);
            background-color: #fff;
            cursor: pointer;
            outline: none;
            transition: border-color 0.2s;
            min-width: 250px;
        }

        select:hover {
            border-color: var(--primary);
        }

        select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }

        /* KPI CARDS */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .kpi-card h3 {
            margin: 0 0 10px 0;
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }

        .kpi-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .kpi-trend {
            font-size: 0.9rem;
            margin-top: 5px;
            font-weight: 500;
        }

        .trend-up {
            color: var(--success);
        }

        .trend-down {
            color: var(--danger);
        }

        /* TABS */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            background: transparent;
            border: none;
            padding: 12px 24px;
            font-family: var(--font-main);
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: var(--primary);
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .section {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* CHARTS SECTION */
        .charts-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            height: 350px;
            position: relative;
        }

        /* DATA TABLE */
        .table-container {
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        thead th {
            text-align: right;
            padding: 12px 16px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            border-bottom: 2px solid var(--border);
            text-transform: uppercase;
            white-space: nowrap;
        }

        thead th:first-child {
            text-align: left;
        }

        /* Group Headers */
        thead tr:first-child th {
            text-align: center;
            background-color: var(--bg-body);
            border-right: 1px solid rgba(0, 0, 0, 0.05);
        }

        tbody td {
            text-align: right;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            color: var(--text-main);
            font-variant-numeric: tabular-nums;
        }

        tbody td:first-child {
            text-align: left;
            font-weight: 600;
            position: sticky;
            left: 0;
            background: var(--bg-card);
            z-index: 10;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.02);
        }

        tbody tr:hover {
            background-color: #f1f5f9;
        }

        /* Inputs */
        input.editable {
            width: 80px;
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            text-align: right;
            font-family: var(--font-main);
            font-weight: 600;
            transition: all 0.2s;
            background: #fff;
        }

        input.editable:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* Utilities */
        .text-left {
            text-align: left !important;
        }

        .text-center {
            text-align: center !important;
        }

        .bg-group-rev {
            background-color: rgba(16, 185, 129, 0.03);
        }

        .bg-group-adr {
            background-color: rgba(59, 130, 246, 0.03);
        }

        .bg-group-occ {
            background-color: rgba(245, 158, 11, 0.03);
        }

        .text-success {
            color: var(--success);
            font-weight: 600;
        }

        .text-danger {
            color: var(--danger);
            font-weight: 600;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-otb {
            background-color: #d1fae5;
            color: #065f46;
        }

        /* Footer Totals */
        tfoot td {
            font-weight: 700;
            background-color: #eff6ff;
            border-top: 2px solid #bfdbfe;
        }

        .occ-warning {
            color: var(--danger);
            font-weight: 800;
        }

        /* BONUS PAGE */
        .bonus-highlight-row td {
            background-color: #f0fdf4 !important;
        }

        .bonus-cell {
            color: var(--primary-dark);
            font-weight: 700;
        }

        /* TOP NAVIGATION */
        .top-nav {
            background: #1e293b;
            padding: 6px 20px;
            display: flex;
            justify-content: center;
            gap: 25px;
            position: sticky;
            top: 0;
            z-index: 99999;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .top-nav a {
            color: #94a3b8;
            text-decoration: none;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            padding: 4px 0;
            font-family: 'Inter', sans-serif;
        }

        .top-nav a:hover {
            color: #ffffff;
            transform: translateY(-1px);
        }

        .top-nav a.active {
            color: #818cf8;
            border-bottom: 2px solid #818cf8;
        }
    </style>
</head>

<body style="padding: 0;">
    <nav class="top-nav">
        <a href="index.html">üè† Inicio</a>
        <a href="AnalisisProduccion.html">üìà Producci√≥n</a>
        <a href="AnalisisSegmentos.html">üë• Segmentos</a>
        <a href="AnalisisCompetencia.html">‚öñÔ∏è Competencia</a>
        <a href="CalculadoraPresupuesto.html" class="active">üí∞ Presupuesto</a>
        <a href="CargarDatos.html">‚öôÔ∏è Config</a>
    </nav>
    <div class="app-container" style="padding: 20px;">

        <!-- HEADER -->
        <header>
            <div style="display: flex; align-items: center; gap: 20px;">
                <a href="index.html" title="Volver al Inicio" style="display:flex; align-items:center;">
                    <img src="Imagen/logo, CapaSuite.png" alt="CapaSuite" style="height: 40px; width: auto;">
                </a>
                <img id="hotelLogo" src="Imagen/logo-guadiana.svg" alt="Hotel" style="height: 35px; width: auto;">
                <div class="header-title">
                    <h1>Presupuestos 2026</h1>
                    <p>Panel Avanzado de Presupuestos y Control</p>
                </div>
            </div>
            <div class="strategy-control">
                <div class="select-wrapper">
                    <select id="hotelSelector" onchange="switchHotel()">
                        <option value="Guadiana">Hotel Guadiana</option>
                        <option value="Cumbria">Hotel Cumbria</option>
                    </select>
                </div>
                <label for="strategySelector"
                    style="font-weight: 500; font-size: 0.9rem; margin-left: 10px;">Estrategia:</label>
                <div class="select-wrapper">
                    <select id="strategySelector" onchange="loadStrategy()">
                        <option value="original">üî¥ Propuesta Central (Original)</option>
                        <option value="optionB" selected>‚úÖ Opci√≥n B: L√≥gica (Recomendada)</option>
                        <option value="optionC">üí∞ Opci√≥n C: Maximizar Precio</option>
                    </select>
                </div>
            </div>
        </header>

        <!-- KPI DASHBOARD -->
        <div class="kpi-grid">
            <div class="card kpi-card">
                <h3>Total Revenue 2026</h3>
                <div class="kpi-value" id="kpi-revenue">0 ‚Ç¨</div>
                <div class="kpi-trend" id="kpi-rev-trend">+0.0% vs 2025</div>
            </div>
            <div class="card kpi-card">
                <h3>ADR Promedio</h3>
                <div class="kpi-value" id="kpi-adr">0 ‚Ç¨</div>
                <div class="kpi-trend" id="kpi-adr-trend">+0.0% vs 2025</div>
            </div>
            <div class="card kpi-card">
                <h3>Ocupaci√≥n Media</h3>
                <div class="kpi-value" id="kpi-occ">0%</div>
                <div class="kpi-trend" id="kpi-occ-trend">Target: > 70%</div>
            </div>
            <div class="card kpi-card">
                <h3>Bonus Proyectado</h3>
                <div class="kpi-value" style="color: var(--primary-dark);" id="kpi-bonus">0 ‚Ç¨</div>
                <div class="kpi-trend">Comisi√≥n del 4%</div>
            </div>
        </div>

        <!-- TABS -->
        <div>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('tab-dashboard')">üìä Panel de Control</button>
                <button class="tab-btn" onclick="switchTab('tab-detail')">üìë Vista Detallada</button>
                <button class="tab-btn" onclick="switchTab('tab-bonus')">üí∞ Calculadora de Incentivos</button>
            </div>
        </div>

        <!-- MAIN CONTENT -->

        <!-- DASHBOARD VIEW -->
        <div id="tab-dashboard" class="section active">
            <div class="charts-container">
                <div class="chart-card">
                    <canvas id="mainChart"></canvas>
                </div>
                <div class="chart-card">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>

            <div class="table-container">
                <!-- Simplified Editor Table -->
                <div style="padding: 15px; background: #fff; border-bottom: 1px solid var(--border);">
                    <h3 style="margin:0;">Edici√≥n R√°pida (Revenue & ADR)</h3>
                </div>
                <div class="table-responsive">
                    <table id="editorTable">
                        <thead>
                            <tr>
                                <th>Mes</th>
                                <th>Revenue 2026 (Target)</th>
                                <th>ADR Target</th>
                                <th>Ocupaci√≥n Resultante</th>
                            </tr>
                        </thead>
                        <tbody id="editorBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- DETAILED TABLE VIEW -->
        <div id="tab-detail" class="section">
            <div class="table-container table-responsive">
                <table id="fullTable">
                    <thead>
                        <tr>
                            <th rowspan="2" class="text-left">Mes</th>
                            <th rowspan="2">Capacidad</th>
                            <th colspan="3" class="bg-group-rev">INGRESOS (Revenue)</th>
                            <th colspan="3" class="bg-group-adr">PRECIO MEDIO (ADR)</th>
                            <th colspan="3" class="bg-group-occ">HABITACIONES (RN)</th>
                            <th colspan="2">OCUPACI√ìN %</th>
                        </tr>
                        <tr>
                            <th class="bg-group-rev" style="font-size: 0.75rem;">Real 25</th>
                            <th class="bg-group-rev">OBJETIVO 26</th>
                            <th class="bg-group-rev">Var %</th>

                            <th class="bg-group-adr" style="font-size: 0.75rem;">Real 25</th>
                            <th class="bg-group-adr">OBJETIVO 26</th>
                            <th class="bg-group-adr">Var %</th>

                            <th class="bg-group-occ" style="font-size: 0.75rem;">Real 25</th>
                            <th class="bg-group-occ">NECESARIO</th>
                            <th class="bg-group-occ">Var %</th>

                            <th style="font-size: 0.75rem;">Real 25</th>
                            <th>OBJ 26</th>
                        </tr>
                    </thead>
                    <tbody id="fullBody"></tbody>
                    <tfoot id="fullFoot"></tfoot>
                </table>
            </div>
        </div>

        <!-- BONUS VIEW -->
        <div id="tab-bonus" class="section">
            <div class="card"
                style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="margin:0;">Estado de Incentivos</h3>
                    <p style="margin:0; color: var(--text-muted);">Comparativa OTB (Vendido) vs Objetivo definido</p>
                </div>
                <div class="badge badge-otb" style="font-size:1rem; padding: 10px 15px;">Comisi√≥n: 4.0%</div>
            </div>

            <div class="table-container table-responsive">
                <table class="bonus-table">
                    <thead>
                        <tr>
                            <th class="text-left">Mes</th>
                            <th>Objetivo (Target)</th>
                            <th>Vendido / OTB (Real)</th>
                            <th>Desviaci√≥n</th>
                            <th>Super√°vit (‚Ç¨)</th>
                            <th style="background-color: var(--primary); color: white;">BONUS 4% (‚Ç¨)</th>
                        </tr>
                    </thead>
                    <tbody id="bonusBody"></tbody>
                    <tfoot>
                        <tr>
                            <td class="text-left">TOTAL ANUAL</td>
                            <td id="t2_target">0 ‚Ç¨</td>
                            <td id="t2_sold">0 ‚Ç¨</td>
                            <td id="t2_gap">0 ‚Ç¨</td>
                            <td id="t2_surplus">0 ‚Ç¨</td>
                            <td id="t2_bonus"
                                style="background-color: var(--primary); color: white; font-size: 1.1rem;">0 ‚Ç¨</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

    </div>

    <script>
        // --- DATOS POR HOTEL ---
        const hotelData = {
            Guadiana: {
                logo: 'Imagen/logo-guadiana.svg',
                capacity: [3162, 2856, 3162, 3060, 3162, 3060, 3162, 3162, 3060, 3162, 3060, 3162],
                real2025: {
                    rev: [46629, 65367, 84793, 115352, 160450, 107417, 129720, 124567, 140798, 156106, 111396, 92671],
                    adr: [59.55, 58.89, 60.65, 66.33, 80.87, 67.52, 70.58, 58.18, 59.91, 59.20, 62.41, 60.49],
                    rn: [783, 1110, 1398, 1739, 1984, 1591, 1838, 2141, 2350, 2637, 1785, 1532]
                },
                otbData: [66127, 37552, 97753, 130646, 49692, 44094, 21440, 4151, 21767, 36394, 828, 10448],
                strategies: {
                    original: {
                        rev: [66789, 71441, 106875, 130251, 125309, 118652, 121962, 131039, 148593, 163911, 114738, 95813],
                        adr: [61.50, 61.80, 75.00, 70.33, 69.50, 70.50, 69.10, 61.09, 62.91, 62.16, 64.28, 62.50]
                    },
                    optionB: {
                        rev: [66127, 69000, 96875, 130251, 138309, 118652, 121962, 131039, 148593, 164020, 114738, 95813],
                        adr: [64.64, 61.83, 68.03, 70.33, 76.04, 70.50, 69.10, 61.09, 62.91, 62.20, 64.28, 62.20]
                    },
                    optionC: {
                        rev: [66127, 69000, 100000, 130251, 140000, 118652, 121962, 125000, 148593, 164020, 114738, 95813],
                        adr: [64.64, 62.00, 78.00, 72.00, 80.00, 70.50, 69.10, 62.00, 63.00, 63.00, 65.00, 63.00]
                    }
                }
            },
            Cumbria: {
                logo: 'Imagen/logo-cumbria.svg',
                capacity: [3720, 3360, 3720, 3600, 3720, 3600, 3720, 3720, 3600, 3720, 3600, 3720],
                real2025: {
                    rev: [78000, 85000, 98000, 125000, 148000, 135000, 155000, 145000, 140000, 135000, 115000, 98000],
                    adr: [66.00, 69.00, 73.00, 76.00, 86.00, 83.00, 89.00, 85.00, 83.00, 79.00, 75.00, 71.00],
                    rn: [1182, 1232, 1342, 1645, 1721, 1627, 1742, 1706, 1687, 1709, 1533, 1380]
                },
                otbData: [84000, 48000, 115000, 138000, 158000, 145000, 165000, 155000, 148000, 138000, 98000, 88000],
                strategies: {
                    original: {
                        rev: [88000, 92000, 108000, 135000, 158000, 145000, 168000, 158000, 155000, 148000, 128000, 115000],
                        adr: [71.00, 73.00, 76.00, 79.00, 89.00, 86.00, 93.00, 89.00, 86.00, 83.00, 79.00, 76.00]
                    },
                    optionB: {
                        rev: [84000, 90000, 105000, 132000, 155000, 142000, 165000, 155000, 152000, 145000, 125000, 112000],
                        adr: [72.00, 74.00, 77.00, 81.00, 91.00, 88.00, 96.00, 92.00, 89.00, 86.00, 81.00, 79.00]
                    },
                    optionC: {
                        rev: [84000, 90000, 115000, 138000, 162000, 148000, 172000, 162000, 158000, 152000, 132000, 118000],
                        adr: [73.00, 76.00, 83.00, 86.00, 96.00, 91.00, 101.00, 96.00, 93.00, 91.00, 86.00, 83.00]
                    }
                }
            }
        };

        const months = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];

        let currentHotel = "Guadiana";
        let currentRev = [];
        let currentAdr = [];
        let chartInstance = null;
        let pieInstance = null;

        function init() {
            switchHotel();
        }

        function switchHotel() {
            currentHotel = document.getElementById('hotelSelector').value;
            const h = hotelData[currentHotel];
            document.getElementById('hotelLogo').src = h.logo;

            // Try to load OTB from DB
            const db = JSON.parse(CapaStorage.getItem('hotel_manager_db_v2')) || {};
            const year = "2026";
            if (db[currentHotel] && db[currentHotel][year] && db[currentHotel][year].otb) {
                h.otbData = [...db[currentHotel][year].otb.revenue];
            }

            loadStrategy();
        }

        function switchTab(id) {
            document.querySelectorAll('.section').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            // Find the button that calls this and add active (simple way)
            [...document.querySelectorAll('.tab-btn')].find(b => b.getAttribute('onclick').includes(id)).classList.add('active');
        }

        function loadStrategy() {
            const h = hotelData[currentHotel];
            const key = document.getElementById('strategySelector').value;
            currentRev = [...h.strategies[key].rev];
            currentAdr = [...h.strategies[key].adr];
            updateAll();
        }

        function updateValue(type, index, val) {
            const v = parseFloat(val);
            if (isNaN(v)) return;
            if (type === 'rev') currentRev[index] = v;
            if (type === 'adr') currentAdr[index] = v;
            updateAll();
        }

        function updateAll() {
            renderDashboard();
            renderCharts();
            renderDetailTable();
            renderBonusTable();
        }

        // --- RENDERERS ---
        function renderDashboard() {
            const h = hotelData[currentHotel];
            const editorBody = document.getElementById('editorBody');
            editorBody.innerHTML = '';

            let t_rev25 = 0, t_rev26 = 0, t_adr_acc = 0, t_rn26 = 0, t_cap = 0, t_bonus = 0;

            for (let i = 0; i < 12; i++) {
                const rev = currentRev[i];
                const adr = currentAdr[i];
                const rn = adr > 0 ? Math.round(rev / adr) : 0;
                const occ = (rn / h.capacity[i]) * 100;

                // Totales acumulados
                t_rev25 += h.real2025.rev[i];
                t_rev26 += rev;
                t_rn26 += rn;
                t_cap += h.capacity[i];

                // Bonus logic for KPI
                const sold = h.otbData[i];
                const surplus = Math.max(0, sold - rev);
                t_bonus += (surplus * 0.04);

                const occStyle = occ > 100 ? 'color: var(--danger); font-weight:800;' : (occ > 80 ? 'color: var(--warning);' : 'color: var(--success);');

                editorBody.innerHTML += `
                <tr>
                    <td class="text-left font-bold">${months[i]}</td>
                    <td><input type="number" class="editable" value="${rev}" onchange="updateValue('rev', ${i}, this.value)"></td>
                    <td><input type="number" class="editable" value="${adr.toFixed(2)}" step="0.5" onchange="updateValue('adr', ${i}, this.value)"></td>
                    <td style="${occStyle}">${occ.toFixed(1)}%</td>
                </tr>
            `;
            }

            // Update KPI Cards
            const totalAdr = t_rn26 > 0 ? t_rev26 / t_rn26 : 0;
            const totalOcc = (t_rn26 / t_cap) * 100;
            const totalRev25 = t_rev25;
            const growth = ((t_rev26 - totalRev25) / totalRev25) * 100;

            document.getElementById('kpi-revenue').innerText = formatMoney(t_rev26);
            const kpiTrend = document.getElementById('kpi-rev-trend');
            kpiTrend.innerHTML = `${growth > 0 ? '‚ñ≤' : '‚ñº'} ${growth.toFixed(1)}% vs 2025`;
            kpiTrend.className = `kpi-trend ${growth >= 0 ? 'trend-up' : 'trend-down'}`;

            document.getElementById('kpi-adr').innerText = formatMoney(totalAdr).replace('‚Ç¨', ''); // Just number maybe?

            // ADR Trend vs 2025 avg
            const avgAdr25 = 63.67; // approx derived from data
            const adrGrowth = ((totalAdr - avgAdr25) / avgAdr25) * 100;
            document.getElementById('kpi-adr-trend').innerText = `${adrGrowth > 0 ? '+' : ''}${adrGrowth.toFixed(1)}% vs 2025`;

            document.getElementById('kpi-occ').innerText = totalOcc.toFixed(1) + "%";

            document.getElementById('kpi-bonus').innerText = formatMoney(t_bonus);
        }

        function renderCharts() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const ctxPie = document.getElementById('pieChart').getContext('2d');

            // Main Chart (Revenue vs Last Year)
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Real 2025',
                            data: real2025.rev,
                            borderColor: '#94a3b8',
                            backgroundColor: 'rgba(148, 163, 184, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Objetivo 2026',
                            data: currentRev,
                            borderColor: '#4f46e5', // Primary
                            backgroundColor: 'rgba(79, 70, 229, 0.05)',
                            borderWidth: 3,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#4f46e5',
                            pointRadius: 5,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Evoluci√≥n de Ingresos (Revenue Comparison)' }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Pie Chart (Distribution by Quarter approx)
            // Group data into Q1, Q2, Q3, Q4
            const qData = [0, 0, 0, 0];
            currentRev.forEach((v, i) => {
                if (i < 3) qData[0] += v;
                else if (i < 6) qData[1] += v;
                else if (i < 9) qData[2] += v;
                else qData[3] += v;
            });

            if (pieInstance) pieInstance.destroy();
            pieInstance = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: ['Q1 (Invierno)', 'Q2 (Prim)', 'Q3 (Verano)', 'Q4 (Oto√±o)'],
                    datasets: [{
                        data: qData,
                        backgroundColor: ['#60a5fa', '#34d399', '#ffbbf24', '#818cf8'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        title: { display: true, text: 'Distribuci√≥n Trimestral' },
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function renderDetailTable() {
            const h = hotelData[currentHotel];
            const tbody = document.getElementById('fullBody');
            const tfoot = document.getElementById('fullFoot');
            tbody.innerHTML = '';

            let t_cap = 0, t_rev25 = 0, t_rev26 = 0, t_rn25 = 0, t_rn26 = 0;

            for (let i = 0; i < 12; i++) {
                const rev = currentRev[i];
                const adr = currentAdr[i];
                const rn = adr > 0 ? Math.round(rev / adr) : 0;
                const occ = (rn / h.capacity[i]) * 100;

                // Variaciones
                const varRev = ((rev - h.real2025.rev[i]) / h.real2025.rev[i]) * 100;
                const varAdr = ((adr - h.real2025.adr[i]) / h.real2025.adr[i]) * 100;
                const varRn = ((rn - h.real2025.rn[i]) / h.real2025.rn[i]) * 100;

                // Running Totals
                t_cap += h.capacity[i];
                t_rev25 += h.real2025.rev[i];
                t_rev26 += rev;
                t_rn25 += h.real2025.rn[i];
                t_rn26 += rn;

                const occClass = occ > 100 ? 'occ-warning' : '';

                tbody.innerHTML += `<tr>
                <td>${months[i]}</td>
                <td style="color:#64748b;">${formatNum(h.capacity[i])}</td>
                
                <td style="color:#94a3b8;">${formatNum(h.real2025.rev[i])}‚Ç¨</td>
                <td style="font-weight:600;">${formatNum(rev)}‚Ç¨</td>
                <td class="${varRev >= 0 ? 'text-success' : 'text-danger'}">${(varRev > 0 ? '+' : '')}${varRev.toFixed(1)}%</td>

                <td style="color:#94a3b8;">${h.real2025.adr[i].toFixed(1)}‚Ç¨</td>
                <td style="font-weight:600;">${adr.toFixed(2)}‚Ç¨</td>
                <td class="${varAdr >= 0 ? 'text-success' : 'text-danger'}">${(varAdr > 0 ? '+' : '')}${varAdr.toFixed(1)}%</td>

                <td style="color:#94a3b8;">${formatNum(h.real2025.rn[i])}</td>
                <td>${formatNum(rn)}</td>
                <td class="${varRn >= 0 ? 'text-success' : 'text-danger'}">${(varRn > 0 ? '+' : '')}${varRn.toFixed(1)}%</td>

                <td style="color:#94a3b8;">${(h.real2025.rn[i] / h.capacity[i] * 100).toFixed(1)}%</td>
                <td class="${occClass}">${occ.toFixed(1)}%</td>
            </tr>`;
            }

            // Totals Footer
            const t_adr25 = t_rev25 / t_rn25;
            const t_adr26 = t_rev26 / t_rn26;
            const t_occ25 = t_rn25 / t_cap * 100;
            const t_occ26 = t_rn26 / t_cap * 100;
            const tv_rev = ((t_rev26 - t_rev25) / t_rev25) * 100;

            tfoot.innerHTML = `<tr>
            <td>TOTAL</td>
            <td>${formatNum(t_cap)}</td>
            <td>${formatMoney(t_rev25)}</td>
            <td>${formatMoney(t_rev26)}</td>
            <td>${(tv_rev > 0 ? '+' : '') + tv_rev.toFixed(1)}%</td>
            
            <td>${t_adr25.toFixed(2)}‚Ç¨</td>
            <td>${t_adr26.toFixed(2)}‚Ç¨</td>
            <td>-</td>
            
            <td>${formatNum(t_rn25)}</td>
            <td>${formatNum(t_rn26)}</td>
            <td>-</td>
            
            <td>${t_occ25.toFixed(1)}%</td>
            <td>${t_occ26.toFixed(1)}%</td>
        </tr>`;
        }

        function renderBonusTable() {
            const h = hotelData[currentHotel];
            const tbody = document.getElementById('bonusBody');
            tbody.innerHTML = '';
            let t_target = 0, t_sold = 0, t_surplus = 0, t_bonus = 0;

            for (let i = 0; i < 12; i++) {
                const target = currentRev[i];
                const sold = h.otbData[i];
                const surplus = Math.max(0, sold - target);
                const gap = target - sold;
                const bonus = surplus * 0.04;

                t_target += target;
                t_sold += sold;
                t_surplus += surplus;
                t_bonus += bonus;

                // highlight checked months
                const isMet = sold >= target;
                const rowClass = isMet ? 'bonus-highlight-row' : '';
                const statusIcon = isMet ? '‚úÖ' : '';

                tbody.innerHTML += `<tr class="${rowClass}">
                <td class="text-left font-bold">${months[i]} ${statusIcon}</td>
                <td style="color:var(--text-muted);">${formatMoney(target)}</td>
                <td style="font-weight:bold;">${formatMoney(sold)}</td>
                <td class="${gap <= 0 ? 'text-success' : 'text-danger'}">${gap <= 0 ? '+' : '-'}${formatMoney(Math.abs(gap))}</td>
                <td>${surplus > 0 ? formatMoney(surplus) : '-'}</td>
                <td style="${bonus > 0 ? 'color:var(--primary); font-weight:700;' : ''}">${bonus > 0 ? formatMoney(bonus) : '-'}</td>
            </tr>`;
            }

            document.getElementById("t2_target").innerText = formatMoney(t_target);
            document.getElementById("t2_sold").innerText = formatMoney(t_sold);
            document.getElementById("t2_gap").innerText = formatMoney(t_target - t_sold);
            document.getElementById("t2_surplus").innerText = formatMoney(t_surplus);
            document.getElementById("t2_bonus").innerText = formatMoney(t_bonus);
        }

        const formatMoney = (n) => {
            if (n === 0 || n === null || n === undefined) return "0 ‚Ç¨";
            return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + " ‚Ç¨";
        };
        const formatNum = (n) => {
            if (n === 0 || n === null || n === undefined) return "0";
            return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        };
        window.onload = init;

    </script>
</body>

</html>